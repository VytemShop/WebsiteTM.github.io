
var FRVRSDK=function(e){"use strict";function t(e,t){var r={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(r[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var s=0;for(i=Object.getOwnPropertySymbols(e);s<i.length;s++)t.indexOf(i[s])<0&&Object.prototype.propertyIsEnumerable.call(e,i[s])&&(r[i[s]]=e[i[s]])}return r}function r(e,t,r,i){return new(r||(r=Promise))((function(s,o){function n(e){try{d(i.next(e))}catch(e){o(e)}}function a(e){try{d(i.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?s(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(n,a)}d((i=i.apply(e,t||[])).next())}))}var i;e.Env=void 0,(i=e.Env||(e.Env={})).DEVELOPMENT="dev",i.BETA="beta",i.PRODUCTION="prod";const s={log:()=>{},error:()=>{},warn:()=>{},info:()=>{},debug:()=>{}};class o{constructor({provider:e,logger:t}){this.provider=e,this.logger=t||s}setItems(e){const t=e.map((({key:e,value:t})=>({key:e,value:JSON.stringify(t)})));return this.provider.setItems(t)}getItems(e){return r(this,void 0,void 0,(function*(){const t=yield this.provider.getItems(e),r={};for(const e in t)try{r[e]=JSON.parse(t[e])}catch(i){r[e]=t[e],this.logger.error(`[storage] parsing error on key ${e}`,i.message)}return r}))}removeItems(e){return this.provider.removeItems(e)}setItem(e,t){return this.provider.setItems([{key:e,value:JSON.stringify(t)}])}getItem(e,t){return r(this,void 0,void 0,(function*(){let r;const i=(yield this.provider.getItems([e]))[e];try{r=void 0!==i?JSON.parse(i):t}catch(s){r=null!=t?t:i,this.logger.error(`[storage] parsing error on key ${e}`,s.message)}return r}))}removeItem(e){return r(this,void 0,void 0,(function*(){return this.provider.removeItems([e])}))}isPersistent(){return this.provider.isPersistent()}}const n="test-01e0e1c8-2a13-4fe9-b8d0-458a98c4fc89";class a{static isSupported(){try{return window.localStorage.setItem(n,"test"),window.localStorage.removeItem(n),!0}catch(e){return!1}}setItems(e){return r(this,void 0,void 0,(function*(){for(const t of e)window.localStorage.setItem(t.key,t.value)}))}getItems(e){return r(this,void 0,void 0,(function*(){const t={};for(const r of e){const e=window.localStorage.getItem(r);null!==e&&(t[r]=e)}return t}))}removeItems(e){return r(this,void 0,void 0,(function*(){for(const t of e)window.localStorage.removeItem(t)}))}isPersistent(){return!0}}a.providerName="web";class d{constructor(){this.values={}}setItems(e){return r(this,void 0,void 0,(function*(){for(const t of e)this.values[t.key]=t.value}))}getItems(e){return r(this,void 0,void 0,(function*(){const t={};for(const r of e){const e=this.values[r];void 0!==e&&(t[r]=e)}return t}))}removeItems(e){return r(this,void 0,void 0,(function*(){for(const t of e)delete this.values[t]}))}isPersistent(){return!1}}d.providerName="memory";const c=new o({provider:new d}),h=e=>{for(const t of e)switch(t){case a.providerName:if(a.isSupported())return new a;break;case d.providerName:return new d;default:throw new Error("Unsupported Local Storage provider")}throw new Error("Error initializing Local Storage provider")},l={init:()=>Promise.resolve(),setProgress:()=>{},complete:()=>Promise.resolve()};function u(){this.code="INVALID_OPERATION",this.message="Trying to use an empty interface."}const g={init:()=>r(void 0,void 0,void 0,(function*(){})),canCreateShortcut:()=>Promise.resolve(!1),createShortcut:()=>Promise.reject(new u)};function v(){this.code="INVALID_OPERATION",this.message="Trying to use an empty interface."}const p={needsConfiguration:()=>!1,canMoveToMobile:()=>Promise.resolve(!1),moveToMobile:()=>Promise.reject(new v)};var m;e.ConsentOptions=void 0,(m=e.ConsentOptions||(e.ConsentOptions={}))[m.None=0]="None",m[m.P1StoreInformationOnADevice=2]="P1StoreInformationOnADevice",m[m.P2SelectBasicAds=4]="P2SelectBasicAds",m[m.P3PersonalizedAdsProfile=8]="P3PersonalizedAdsProfile",m[m.P4PersonalizedAds=16]="P4PersonalizedAds",m[m.P5PersonalizedContentProfile=32]="P5PersonalizedContentProfile",m[m.P6PersonalizedContent=64]="P6PersonalizedContent",m[m.P7MeasureAdPerformance=128]="P7MeasureAdPerformance",m[m.P8MeasureContentPerformance=256]="P8MeasureContentPerformance",m[m.P9MarketResearchForAudienceInsights=512]="P9MarketResearchForAudienceInsights",m[m.P10DevelopAndImproveProducts=1024]="P10DevelopAndImproveProducts",m[m.All=2046]="All";const f={consentToTerms:()=>{},onConsentChanged(e){},hasConsentForAll:(e,t)=>!1,hasConsentForAny:(e,t)=>!1,consents:()=>e.ConsentOptions.None,legitimateInterests:()=>e.ConsentOptions.None,hasLoaded:()=>!0,isConsentEditable:()=>!1},y={consentToTerms:()=>{},onConsentChanged(e){},hasConsentForAll:(e,t)=>!0,hasConsentForAny:(e,t)=>!0,consents:()=>e.ConsentOptions.All,legitimateInterests:()=>e.ConsentOptions.All,hasLoaded:()=>!0,isConsentEditable:()=>!1},I={id:()=>"",name:()=>"",nickname:()=>"",image:()=>"",loadImage:()=>Promise.reject(new Error("EMPTY_PROFILE"))},P={allowExternalLinks:!0,allowInternalLinks:!0,allowNavigation:!0,allowSendBeacon:!0,allowThirdPartyDomains:!0,hasDedicatedLoadingScreen:!0},S={getData:()=>Promise.reject(new Error("EMPTY_ENTRYPOINT_DATA")),getName:()=>Promise.reject(new Error("EMPTY_ENTRYPOINT_NAME"))},E={canFollowOfficialPage:()=>Promise.resolve(!1),followOfficialPage:()=>Promise.reject(new Error("EMPTY_FOLLOW_OFFICIAL_PAGE")),canJoinOfficialGroup:()=>Promise.resolve(!1),joinOfficialGroup:()=>Promise.reject(new Error("EMPTY_FOLLOW_OFFICIAL_GROUP"))};const b={canNavigate:()=>!1,navigate:()=>{throw new Error("EMPTY_NAVIGATE_IMPLEMENTATION")},canOpenChannelAppStore:()=>!1,openChannelAppStore:()=>{throw new Error("EMPTY_OPEN_CHANNEL_STORE_IMPLEMENTATION")}},_={canCrosspromo:()=>Promise.resolve(!1),openGame:()=>{throw new Error("Crosspromo not implemented")}};var A;e.AdType=void 0,(A=e.AdType||(e.AdType={})).INTERSTITIAL="interstitial",A.REWARD="reward",A.BANNER="banner",A.SURVEY="survey",A.REWARDED_INTERSTITIAL="rewarded-interstitial";const T={[e.AdType.INTERSTITIAL]:{stopsGameFlow:!0,throttleable:!0},[e.AdType.REWARD]:{stopsGameFlow:!0,throttleable:!1},[e.AdType.BANNER]:{stopsGameFlow:!1,throttleable:!1},[e.AdType.SURVEY]:{stopsGameFlow:!0,throttleable:!0},[e.AdType.REWARDED_INTERSTITIAL]:{stopsGameFlow:!0,throttleable:!0}},R={onSuspend:()=>{},onResume:()=>{},onAudioSuspend:()=>{},onAudioResume:()=>{}};var C,w,O;e.AdSuccess=void 0,(C=e.AdSuccess||(e.AdSuccess={})).DELIVERED="delivered",C.COMPLETED="completed",e.AdError=void 0,(w=e.AdError||(e.AdError={})).ON_LOAD="on_load",w.ON_SHOW="on_show",w.BLOCKED="blocked",w.NOFILL="nofill",w.TIMED_OUT="timed_out",e.AdsThrottlerResult=void 0,(O=e.AdsThrottlerResult||(e.AdsThrottlerResult={}))[O.NO_THROTTLING=0]="NO_THROTTLING",O.INIT_TIME="INIT_TIME",O.FREQUENCY="FREQUENCY";class k{constructor(){this.maxfrequency=0,this.initTimeBlock=0,this.forceFirstAd=!1,this.MAX_FREQUENCY_DEFAULT=3e5,this.FIRST_SESSION_AD_SPEED_RATE=3}getFirstIntervalTime(e){const t=e.isFirstAdEver?this.maxfrequency:this.maxfrequency/this.FIRST_SESSION_AD_SPEED_RATE;return e.initTime-t}getInitialisedState(e){return e.lastShownAd?e:Object.assign(Object.assign({},e),{lastShownAd:this.getFirstIntervalTime(e)})}shouldBlockByInitTime(e,t){return t-e.initTime<this.initTimeBlock}shouldBlockByFrequency(e,t){const r=t-e.lastShownAd;return this.maxfrequency>0&&r<this.maxfrequency&&!(e.isFirstAd&&this.forceFirstAd)}init(e){this.initTimeBlock=e.initTimeBlock||0,this.maxfrequency=void 0===e.maxfrequency?this.MAX_FREQUENCY_DEFAULT:e.maxfrequency,this.forceFirstAd=e.forceFirstAd||!1}mustThrottle(t,r){r=void 0===r?(new Date).getTime():r;const i=this.getInitialisedState(t);return this.shouldBlockByInitTime(i,r)?e.AdsThrottlerResult.INIT_TIME:this.shouldBlockByFrequency(i,r)?e.AdsThrottlerResult.FREQUENCY:e.AdsThrottlerResult.NO_THROTTLING}checkpoint(e,t){return t=void 0===t?(new Date).getTime():t,Object.assign(Object.assign({},e),{isFirstAd:!1,isFirstAdEver:!1,lastShownAd:t})}}const L={logEvent:()=>{}};var N,F;e.AdResponseStatus=void 0,(N=e.AdResponseStatus||(e.AdResponseStatus={})).AD_CLOSED="adclosed",N.AD_LEAVING_APPLICATION="adleavingapplication",N.CANCELED="canceled",N.ERROR="error",N.INTERNAL_ERROR="internalerror",N.INVALID_REQUEST="invalidrequest",N.NETWORK_ERROR="networkerror",N.NOFILL="nofill",N.SUCCESS="success",N.THROTTLED="throttled",N.TIMEOUT="timeout",e.AdFinishedStatus=void 0,(F=e.AdFinishedStatus||(e.AdFinishedStatus={})).ERROR="error",F.NOFILL="nofill",F.SKIPPED="skipped",F.SUCCESS="success",F.TIMEDOUT="timedout";const D={[e.AdType.INTERSTITIAL]:"mandatory",[e.AdType.REWARD]:"rewarded",[e.AdType.BANNER]:"banner"};class U{constructor(e,t){this.tracker=e,this.params=t}getEventName(e){var t;return`ad_${null!==(t=D[this.params.adType])&&void 0!==t?t:this.params.adType}_${e}`}logEvent(t,r){this.tracker.logEvent(t,r,e.ConsentOptions.None)}requestingAd(e,t){const r=this.getEventName("request");this.logEvent(r,Object.assign(Object.assign({},t),{provider:this.params.provider,advertisement_id:e}))}receivedAdResponse(e,t,r){const i=this.getEventName("response");this.logEvent(i,Object.assign(Object.assign({},r),{provider:this.params.provider,advertisement_id:t,ad_response:e}))}willShowAd(e,t,r){const i=this.getEventName("show");this.logEvent(i,Object.assign(Object.assign({},r),{provider:this.params.provider,advertisement_id:t,preloaded:e}))}finishedAd(e,t,r){const i=this.getEventName("finish");this.logEvent(i,Object.assign(Object.assign({},r),{provider:this.params.provider,advertisement_id:t,ad_result:e}))}}var V,x;e.AdShowResult=void 0,(V=e.AdShowResult||(e.AdShowResult={})).NOT_DISPLAYED="not_displayed",V.DELIVERED="delivered",V.COMPLETED="completed";class j{constructor({env:t,logger:r=s,throttler:i,storage:o=c,tracker:n=L,controls:a=R,onBeforeInit:d=(()=>Promise.resolve())}={}){this.config={},this.registeredProviders={},this.providers=[],this.ADSTORAGE_FIRST_TIME_KEY="__ads_firstTimeView",this.adShownListeners=[],this.adShownCount={[e.AdType.INTERSTITIAL]:0,[e.AdType.REWARD]:0,[e.AdType.BANNER]:0,[e.AdType.SURVEY]:0,[e.AdType.REWARDED_INTERSTITIAL]:0},this.AdType=e.AdType,this.AdShowResult=e.AdShowResult,this.env=t,this.logger=r,this.throttler=i||new k,this.storage=o,this.tracker=n,this.controls=a,this.onBeforeInit=d,this.throttlerState={initTime:(new Date).getTime(),isFirstAd:!0,isFirstAdEver:!1,lastShownAd:0}}register(e){const t=`${e.getName()}#${e.getType()}`;this.registeredProviders[t]=e}configure(e){this.config=e}init(){var e;return r(this,void 0,void 0,(function*(){yield null===(e=this.onBeforeInit)||void 0===e?void 0:e.call(this),this.throttlerState.isFirstAdEver=(yield this.storage.getItem(this.ADSTORAGE_FIRST_TIME_KEY,!0))||!1,this.logger.log("[ads] first time ever?",this.throttlerState.isFirstAdEver),this.throttler.init(this.config.throttling||{});const t=[...this.config.providers||[]];t.sort(((e,t)=>e.priority-t.priority));const r=t.map((e=>{const t=`${e.name}#${e.type}`;return{provider:this.registeredProviders[t],providerConfig:e,key:t}})).filter((({provider:e})=>e)).map((({provider:e,providerConfig:t,key:r})=>{const i=new U(this.tracker,{adType:e.getType(),provider:e.getName()});return e.init(t,this.controls,i).then((()=>e)).catch((e=>{this.logger.warn(`[ads] Ad provider ${r} could not be initialised`,e)}))})),i=(yield Promise.all(r)).filter((e=>void 0!==e));this.providers=i}))}getProviders(){return this.providers}getProvidersByType(e){return this.providers.filter((t=>t.getType()===e))}isSupported(e){return this.getProvidersByType(e).length>0}isReady(e){return void 0!==this.getProvidersByType(e).find((e=>e.isReady()))}show(t){return r(this,void 0,void 0,(function*(){const i=T[t].throttleable;if(i){const t=this.throttler.mustThrottle(this.throttlerState);if(t)return this.logger.log("[ads] Ad was throttled, reason =",t),Promise.resolve(e.AdShowResult.NOT_DISPLAYED)}const s=this.getProvidersByType(t);let o=!1;const n=yield function(e,t){const r=i=>{const s=e[i];return s?t(s).then((e=>void 0===e?r(i+1):e)):Promise.resolve(void 0)};return r(0)}(s,(e=>r(this,void 0,void 0,(function*(){try{if(!e.isReady())return void this.logger.warn("[ads] provider",e.getName(),"not ready");o||!T[t].stopsGameFlow||e.useManualControl()||(this.controls.onSuspend(),this.controls.onAudioSuspend(),o=!0);const r=yield e.show();return!1===r.success&&this.logger.error("[ads] show error",r.message),r.success?r.code:void 0}catch(e){this.logger.error("[ads] show error",e)}}))));return o&&(this.controls.onAudioResume(),this.controls.onResume()),void 0!==n?(this.env===e.Env.DEVELOPMENT&&window.focus(),i&&(this.throttlerState=this.throttler.checkpoint(this.throttlerState),yield this.storage.setItem(this.ADSTORAGE_FIRST_TIME_KEY,!1)),this.adShownCount[t]=(this.adShownCount[t]||0)+1,this.notifyAdShown(t),n===e.AdSuccess.COMPLETED?e.AdShowResult.COMPLETED:e.AdShowResult.DELIVERED):e.AdShowResult.NOT_DISPLAYED}))}hide(e){return r(this,void 0,void 0,(function*(){const t=this.getProvidersByType(e);for(const e of t)try{yield e.hide()}catch(e){this.logger.error("[ads] hide error",e)}}))}setUserConsent(e){this.providers.forEach((t=>{var r;return null===(r=t.setUserConsent)||void 0===r?void 0:r.call(t,e)}))}onAdShown(e){this.adShownListeners.push(e)}notifyAdShown(e){this.adShownListeners.forEach((t=>t(e,this.adShownCount)))}getAdShownCount(){return this.adShownCount}}class M{constructor(e,t){this.auth=t,this.baseUrl=e.replace(/\/$/,"")}getFriends(e){var t;return r(this,void 0,void 0,(function*(){const r=yield null===(t=this.auth)||void 0===t?void 0:t.authenticatedFetch(`${this.baseUrl}/friends/${e}`,{method:"GET",headers:{"Content-Type":"application/json"}});if(!(null==r?void 0:r.ok))throw new B(r);return yield r.json()}))}addFriend(e,t){var i;return r(this,void 0,void 0,(function*(){const r=yield null===(i=this.auth)||void 0===i?void 0:i.authenticatedFetch(`${this.baseUrl}/friends/${e}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!(null==r?void 0:r.ok))throw new B(r);return yield r.json()}))}removeFriend(e,t){var i;return r(this,void 0,void 0,(function*(){const r=yield null===(i=this.auth)||void 0===i?void 0:i.authenticatedFetch(`${this.baseUrl}/friends/${e}`,{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!(null==r?void 0:r.ok))throw new B(r)}))}syncFriends(e,t){var i;return r(this,void 0,void 0,(function*(){const r=yield null===(i=this.auth)||void 0===i?void 0:i.authenticatedFetch(`${this.baseUrl}/friends/${e}/sync`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!(null==r?void 0:r.ok))throw new B(r);return yield r.json()}))}}class B extends Error{constructor(e){super(e.statusText),this.response=e,this.response=e,this.name="ResponseError"}}!function(e){e[e.shareMessage=0]="shareMessage",e[e.sendUpdate=1]="sendUpdate",e[e.invite=2]="invite",e[e.getFriends=3]="getFriends",e[e.getContextId=4]="getContextId",e[e.getContextData=5]="getContextData",e[e.getContextPlayers=6]="getContextPlayers"}(x||(x={}));class G{constructor({provider:e}){this.API=x,this.provider=e}shareMessage(e){return this.provider.shareMessage(e)}sendUpdate(e){return this.provider.sendUpdate(e)}canInvite(){return this.provider.canInvite()}invite(e){return this.provider.invite(e)}getFriends(){return this.provider.getFriends()}getContextData(){return this.provider.getContextData()}getContextId(){return this.provider.getContextId()}getContextPlayers(){return this.provider.getContextPlayers()}getSupportedAPIs(){return this.provider.getSupportedAPIs()}isSupportedAPI(e){return-1!==this.provider.getSupportedAPIs().indexOf(e)}}const $={shareMessage(){return r(this,void 0,void 0,(function*(){}))},sendUpdate(){return r(this,void 0,void 0,(function*(){}))},canInvite(){return r(this,void 0,void 0,(function*(){return!1}))},invite(){return r(this,void 0,void 0,(function*(){}))},getContextId(){return r(this,void 0,void 0,(function*(){return Promise.resolve("")}))},getContextData(){return r(this,void 0,void 0,(function*(){return Promise.resolve({})}))},getContextPlayers(){return r(this,void 0,void 0,(function*(){return Promise.resolve([])}))},getFriends(){return r(this,void 0,void 0,(function*(){return Promise.resolve([])}))},getSupportedAPIs:()=>[]};var H,W,K;!function(e){e.UPDATE_STATUS="UPDATE_STATUS",e.SEND_GAME_INVITE="SEND_GAME_INVITE"}(H||(H={})),function(e){e.onFriendStatusUpdated="FRIEND_STATUS_UPDATED",e.onConnect="ON_CONNECT",e.onGameInvite="RECEIVE_GAME_INVITE",e.onError="ON_ERROR"}(W||(W={})),function(e){e.open="open",e.close="close",e.error="error",e.message="message",e.retry="retry"}(K||(K={}));class q{constructor(e){var t;this.retries=0,this.eventListeners={open:[],close:[],error:[],message:[],retry:[]},this.closedByUser=!1,this.RECONNECT_DEFAULT_BACKOFF_MS=1e3,this.RECONNECT_RETRY_MS=500,this.onOpen=e=>this.handleEvent(K.open,e),this.onClose=e=>this.handleEvent(K.close,e),this.onError=e=>this.handleEvent(K.error,e),this.onMessage=e=>this.handleEvent(K.message,e),this.url=e.url,this.logger=e.logger,this.webSocketBuilder=null!==(t=e.webSocketBuilder)&&void 0!==t?t:e=>new WebSocket(e)}send(e){this.websocket?this.getConnectionStatus()===WebSocket.OPEN?this.closedByUser?this.logger.error("WebsocketClient: Cannot send message, closed by user"):this.websocket.send(e):this.logger.error("WebsocketClient: Cannot send message, not connected"):this.logger.error("WebsocketClient: Cannot send message, not initialised")}connect(){return r(this,void 0,void 0,(function*(){this.closedByUser=!1,void 0!==this.websocket&&(this.websocket.removeEventListener(K.open,this.onOpen),this.websocket.removeEventListener(K.close,this.onClose),this.websocket.removeEventListener(K.error,this.onError),this.websocket.removeEventListener(K.message,this.onMessage),this.websocket.close()),this.websocket=this.webSocketBuilder(yield this.url()),this.websocket.addEventListener(K.open,this.onOpen),this.websocket.addEventListener(K.close,this.onClose),this.websocket.addEventListener(K.error,this.onError),this.websocket.addEventListener(K.message,this.onMessage)}))}close(e,t){var r;this.closedByUser=!0,null===(r=this.websocket)||void 0===r||r.close(e,t)}addEventListener(e,t){const r={listener:t};this.eventListeners[e].push(r)}removeEventListener(e,t){this.eventListeners[e]=this.eventListeners[e].filter((e=>e.listener!==t))}getConnectionStatus(){return this.websocket?this.websocket.readyState:WebSocket.CLOSED}handleEvent(e,t){switch(e){case K.close:this.closedByUser||this.reconnect();break;case K.open:this.retries=0;case K.error:case K.message:}this.dispatchEvent(e,t)}reconnect(){const e=this.RECONNECT_RETRY_MS*this.retries+this.RECONNECT_DEFAULT_BACKOFF_MS,t={detail:{retries:this.retries++,backoff:e}};setTimeout((()=>{if(this.closedByUser)return;const e=new CustomEvent(K.retry,t);this.dispatchEvent(K.retry,e),this.connect()}),e)}dispatchEvent(e,t){this.eventListeners[e].forEach((e=>{e.listener(t)}))}}class Y{constructor(e,t){this.friendsStatus=new Map,this.eventListeners={[W.onFriendStatusUpdated]:[],[W.onConnect]:[],[W.onGameInvite]:[],[W.onError]:[]},this.SocialEvents=W;const{apiHost:r,gameId:i}=e;if(this.apiHost=r,this.gameId=i,this.logger=t.logger,this.auth=t.auth,this.websocket=t.webSocketClientBuilder?t.webSocketClientBuilder():new q({logger:this.logger,url:()=>this.getFreshUrl(this.apiHost,this.gameId)}),!this.websocket)throw new Error("websocket client is not defined");this.on(W.onConnect,(({data:e})=>{const t=e.friends;for(const e of t)this.friendsStatus.set(e.userId,e)})),this.on(W.onFriendStatusUpdated,(({data:e})=>{this.friendsStatus.set(e.userId,e)})),this.websocket.addEventListener(K.open,(()=>{this.logger.log("connected to social server")})),this.websocket.addEventListener(K.close,(e=>{this.logger.log("websocket client closed",e)})),this.websocket.addEventListener(K.error,(e=>{this.logger.error("websocket client error",e)})),this.websocket.addEventListener(K.message,(e=>{const{data:t}=e,r=JSON.parse(t);Object.values(W).includes(r.code)?this.dispatchEvent(r.code,r):this.logger.error("event type is not supported")})),this.auth.addStatusChangeListener((e=>this.onAuthStatusChanged(e)))}connect(){const e=this.connectedUser===this.auth.getFRVRID(),t=this.websocket.getConnectionStatus();(t!==WebSocket.OPEN&&t!==WebSocket.CONNECTING||!e)&&(this.connectedUser=this.auth.getFRVRID(),this.websocket.connect())}close(){this.friendsStatus.clear(),this.connectedUser=void 0,this.websocket.close()}on(e,t){const r={listener:t},i=this.eventListeners[e];if(!i)throw new Error(`event type "${e}" is not supported`);i.push(r)}getFriendsStatus(){return Array.from(this.friendsStatus.values())}sendGameInvite(e,t,r){const i={code:H.SEND_GAME_INVITE,data:{recipientId:e,lobbyId:t,gameId:this.gameId,metadata:r}};this.send(i)}updateStatus(e){const t={code:H.UPDATE_STATUS,data:{metadata:e,gameId:this.gameId}};this.send(t)}dispatchEvent(e,t){this.eventListeners[e].forEach((e=>{e.listener(t)}))}send(e){this.websocket.send(JSON.stringify(e))}onAuthStatusChanged(e){return r(this,void 0,void 0,(function*(){if(e){const e=this.websocket.getConnectionStatus();e!==WebSocket.OPEN&&e!==WebSocket.CONNECTING||this.connect()}else this.close()}))}getFreshUrl(e,t){return r(this,void 0,void 0,(function*(){const r=yield this.auth.getFreshAccessToken();return`wss://${e}/ws?token=${r}&gameId=${t}`}))}}class z{constructor(t,r){var i,s,o;this.config=t,this.container=r,this.syncedFriendsbyFRVRIDCache={},this.syncedFriendsbyChannelIDCache={},this.providerFriendsCache={},this.API=x,this.auth=r.auth,this.provider=null!==(i=r.provider)&&void 0!==i?i:$,this.gameId=t.gameId;let n=null!==(s=t.apiHostOverride)&&void 0!==s?s:t.env===e.Env.PRODUCTION?"crucible.frvr.com":"staging.crucible.frvr.com";n+="/v1/social",this.webClient=new M(`https://${n}`,this.auth),this.wsClient=new Y(Object.assign(Object.assign({},this.config),{apiHost:n}),this.container),this.socialPlatform=new G({provider:this.provider}),(null===(o=t.syncFriendsOnLogin)||void 0===o||o)&&this.auth.addStatusChangeListener(this.onAuthStatusChange.bind(this))}get live(){return this.wsClient}get platform(){return this.socialPlatform}syncFriends(){return r(this,void 0,void 0,(function*(){const e=yield this.provider.getFriends(),t=e.reduce(((e,t)=>{var r;const i=null!==(r=e.get(t.channel))&&void 0!==r?r:[];return i.push(t.id),e.set(t.channel,i),e}),new Map),r=[],i=Array.from(t.entries());for(const[e,t]of i){const i=yield this.webClient.syncFriends(this.getUserId(),{channel:e,gameId:this.gameId,friendIds:t});r.push(...i)}return this.syncedFriendsbyFRVRIDCache=r.reduce(((e,t)=>(e[t.userId]=t,e)),{}),this.syncedFriendsbyChannelIDCache=r.reduce(((e,t)=>(e[t.channelUserId]=t,e)),{}),this.providerFriendsCache=e.reduce(((e,t)=>(e[t.id]=t,e)),{}),r}))}getAllFriends(){return r(this,void 0,void 0,(function*(){return yield this.webClient.getFriends(this.getUserId())}))}getFriendByFRVRID(e){return r(this,void 0,void 0,(function*(){const t=this.syncedFriendsbyFRVRIDCache[e];if(!t)return;const r=this.providerFriendsCache[t.channelUserId];return Object.assign(Object.assign({},t),{name:null==r?void 0:r.name,image:null==r?void 0:r.image})}))}getFriendByChannelId(e){return r(this,void 0,void 0,(function*(){const t=this.syncedFriendsbyChannelIDCache[e];if(!t)return;const r=this.providerFriendsCache[e];return Object.assign(Object.assign({},t),{name:null==r?void 0:r.name,image:null==r?void 0:r.image})}))}addFriend(e){return r(this,void 0,void 0,(function*(){return yield this.webClient.addFriend(this.getUserId(),{friendId:e})}))}removeFriend(e){return r(this,void 0,void 0,(function*(){return yield this.webClient.removeFriend(this.getUserId(),{friendId:e})}))}getUserId(){const e=this.auth.getFRVRID();if(null===e)throw new J("not logged in");return e}onAuthStatusChange(e){e&&this.syncFriends()}shareMessage(e){return this.socialPlatform.shareMessage(e)}sendUpdate(e){return this.socialPlatform.sendUpdate(e)}invite(e){return this.socialPlatform.invite(e)}getFriends(){return this.socialPlatform.getFriends()}getSupportedAPIs(){return this.socialPlatform.getSupportedAPIs()}isSupportedAPI(e){return this.socialPlatform.isSupportedAPI(e)}}class J extends Error{constructor(e){super(e)}}const Q={getId:()=>"",isInRoom(){return r(this,void 0,void 0,(function*(){return!1}))},getRoomData(){return r(this,void 0,void 0,(function*(){return{}}))},getRoomId(){return r(this,void 0,void 0,(function*(){return""}))},getPlayers(){return r(this,void 0,void 0,(function*(){return[]}))},getSupportedAPIs:()=>[],isSupportedAPI:e=>!1};class X{constructor(e){var t;this.auth=e.auth,this.provider=null!==(t=e.provider)&&void 0!==t?t:Q}isInRoom(){return this.provider.isInRoom()}getRoomId(){return this.provider.getRoomId()}getRoomData(){return this.provider.getRoomData()}getPlayers(){return this.provider.getPlayers()}getSupportedAPIs(){return this.provider.getSupportedAPIs()}isSupportedAPI(e){return this.provider.isSupportedAPI(e)}}var Z;!function(e){e[e.getRoomData=0]="getRoomData",e[e.isInRoom=1]="isInRoom",e[e.getRoomId=2]="getRoomId",e[e.getPlayers=3]="getPlayers",e[e.subscribeToPlayerJoined=4]="subscribeToPlayerJoined",e[e.subscribeToPlayerLeft=5]="subscribeToPlayerLeft"}(Z||(Z={}));const ee="coeus.frvr.com/v1/tm5";function te(e=(()=>new XMLHttpRequest),t){let i;const s=[];let o=null;const n=!t&&navigator&&"function"==typeof navigator.sendBeacon;let a=!1;const d={protocol_version:"f",app_version:"av",engine_version:"ev",app_build:"ab",cohort:"co",channel:"ch",cmp_consents:"cmpc",cmp_legitimateInterests:"cmpl",games_played:"gp",play_session_id:"pi",play_session_count:"pc",days_elapsed:"de",facebook_player_id:"fi",facebook_context_type:"fc",facebook_entrypoint:"fe",facebook_referral_player_id:"fr",utm_source:"us",utm_medium:"um",utm_campaign:"uc",utm_term:"ut",utm_content:"uo",remote_user_id:"ru",global_user_id:"guid",device_width:"dw",device_height:"dh",non_interaction:"ni",country:"ct",event:"e",game:"g",user:"u",client_time:"t",value:"v",provider:"ao",ad_result:"ar",ad_response:"ag",ad_point:"ap",transport:"tr",web_url:"wu",retry:"r",label:"l",advertisement_id:"ai",script_version:"xv",cache_buster:"n",page_session_id:"si"};function c(e,t,r){r=void 0!==r?r:5,e(t,(function(){if(r>0){const i=5e3*(Math.pow(2,5-r)+Math.random());t.r=5-r+1,setTimeout(c.bind(void 0,e,t,--r),i)}}))}function h(e,t,r){if(navigator.sendBeacon(e,JSON.stringify(t)))return!0;r()}function l(t,r,i){let s=e();s.overrideMimeType&&s.overrideMimeType("text/plain; charset=UTF-8");try{s.open("POST",t,!0),s.setRequestHeader("Content-type","text/plain; charset=UTF-8"),s.withCredentials=!0,s.onreadystatechange=function(){if(4==s.readyState){const e=s.status;s=s.onreadystatechange=null,200!=e&&204!=e?i():a=!0}},s.send(JSON.stringify(r))}catch(e){i()}}function u(e,t,r){t.n=Math.random();const i=document.createElement("img");i.onload=function(){a=!0,i.onerror=i.onload=null},i.onerror=function(){r(),i.onerror=null},i.src=e+"?"+function(e){const t=[];for(const r in e)e.hasOwnProperty(r)&&t.push(encodeURIComponent(r)+"="+(void 0!==e[r]&&null!=e[r]?encodeURIComponent(e[r]):""));return t.join("&")}(t),document.body.appendChild(i)}function g(e,t){return n&&a?(t.transport="bcn",h.bind(void 0,e)):XMLHttpRequest?(t.transport="xhr",l.bind(void 0,e)):(t.transport="img",u.bind(void 0,e+"/i"))}function v(e){const t=e.channel;let r;document&&document.location&&document.location.href&&(r=document.location.href);const s=null==i?void 0:i.getGlobalUserId(),o=null==i?void 0:i.getUserSource(),n=["https://",ee,e.context||"_unspecified_",s||""].join("/");e.app_version=e.app_version||"0.0.0",e.app_build=e.app_build||"000000",e.channel=t||e.channel,e.web_url=r,e.script_version="2.0.1",e.protocol_version=5,e.cache_buster=Math.random(),e.referrer=document.referrer||null,void 0!==s&&(e.global_user_id=s),void 0!==o&&(e.global_user_id_source=o);const a=60*(new Date).getTimezoneOffset()*1e3;e.client_time=new Date(Date.now()-a).toISOString().slice(0,-1);c(g(n,e),function(e){const t={};for(const r in e)e.hasOwnProperty(r)&&void 0!==e[r]&&null!=e[r]&&(t[d[r]||r]=e[r]);return t}(e))}return{init(e,t){return r(this,void 0,void 0,(function*(){i=t}))},getName:()=>"FRVRAnalytics",send(e,t,r,i){var n;r=void 0!==t?Object.assign(Object.assign(Object.assign({value:t},r),i),{event:e}):Object.assign(Object.assign(Object.assign({},r),i),{event:e}),n=r,s.push(n),o&&clearTimeout(o),o=setTimeout((function(){for(;s.length>0;)v(s.shift())}),1)}}}var re;e.AnalyticsIDProviderStorageType=void 0,(re=e.AnalyticsIDProviderStorageType||(e.AnalyticsIDProviderStorageType={})).IN_MEMORY="in-memory",re.COOKIE="cookie",re.LOCAL_STORAGE="localStorage";const ie={init:()=>r(void 0,void 0,void 0,(function*(){})),getName:()=>"",getUserSource:()=>e.AnalyticsIDProviderStorageType.IN_MEMORY,getPageSessionId:()=>"",getPlaySessionId:()=>"",getGlobalUserId:()=>""};function se(e){return(e<10?"0":"")+e}function oe(e){const t=e||"-";function r(){return(65536*(1+Math.random())|0).toString(16).substring(1)}const i=(new Date).getTime().toString(16).slice(0,11)+(65536*(1+Math.random())|0).toString(16).substring(1,2);return r()+r()+t+r()+t+r()+t+r()+t+i}class ne{constructor(t){this.storage=t,this.PLAY_SESSION_TIMEOUT=18e5,this.globalUserIdSource=e.AnalyticsIDProviderStorageType.COOKIE,this.canUseCookies=!1}setCanUseCookies(){document&&void 0!==document.cookie?(document.cookie="can_use_cookies=test;",this.canUseCookies=document.cookie.indexOf("can_use_cookies")>-1):this.canUseCookies=!1}init(){return r(this,void 0,void 0,(function*(){this.setCanUseCookies(),this.canUseCookies?this.globalUserIdSource=e.AnalyticsIDProviderStorageType.COOKIE:this.storage.isPersistent()?this.globalUserIdSource=e.AnalyticsIDProviderStorageType.LOCAL_STORAGE:this.globalUserIdSource=e.AnalyticsIDProviderStorageType.IN_MEMORY;const t=yield this.storage.getItems(["pageSessionId","playSessionId","playSessionIdTimeStamp","globalUserId"]);this.pageSessionId=t.pageSessionId&&String(t.pageSessionId),this.playSessionId=t.playSessionId&&String(t.playSessionId),this.playSessionIdTimeStamp=t.playSessionIdTimeStamp&&parseInt(String(t.playSessionIdTimeStamp),10),this.globalUserId=t.globalUserId&&String(t.globalUserId)}))}getName(){return"FRVRAnalytics"}getUserSource(){return this.globalUserIdSource}getPageSessionId(){return this.pageSessionId||(this.pageSessionId=oe(),this.storage.setItem("pageSessionId",this.pageSessionId)),this.pageSessionId}getPlaySessionId(){if(this.playSessionId){this.playSessionIdTimeStamp+this.PLAY_SESSION_TIMEOUT<Date.now()&&(this.playSessionId=void 0)}return this.playSessionId||(this.playSessionId=oe(),this.storage.setItem("playSessionId",this.playSessionId)),this.playSessionIdTimeStamp=Date.now(),this.storage.setItem("playSessionIdTimeStamp",this.playSessionIdTimeStamp),this.playSessionId}getGlobalUserId(){return this.canUseCookies?this.getGlobalUserIdFromCookie():this.getGlobalUserIdFromStorage()}getGlobalUserIdFromStorage(){return this.globalUserId||(this.globalUserId=oe(),this.storage.setItem("globalUserId",this.globalUserId)),this.globalUserId}getGlobalUserIdFromCookie(){const e=document.cookie.match("^(?:.*_frvr=([^;]*)).*$");return this.globalUserId=e&&e[1]||oe(),this.refreshUserIdCookie(this.globalUserId),this.globalUserId}refreshUserIdCookie(e){const t=new Date;t.setDate(t.getDate()+730),document.cookie="_frvr="+e+"; path=/; expires="+new Date(t).toUTCString()+"; domain="+function(){const e=document.location.hostname.split(".");for(let t=e.length-1;t>=0;t--){const r=e.slice(t).join(".");if(document.cookie="get_tld=test;domain=."+r+";",document.cookie.indexOf("get_tld")>-1)return document.cookie="get_tld=;domain=."+r+";expires=Thu, 01 Jan 1970 00:00:01 GMT;",r}return""}()+";"}}class ae{constructor(t,r){this.consentsBitSet=e.ConsentOptions.None,this.legitimateInterestsBitSet=e.ConsentOptions.None,this.consentIsLoaded=!1,this.getName=()=>"TcfV2ConsentProvider",this.logger=r,this.onConsentChangedHandlers=[],this.loadConsentManagementPlatform(t)}tcfDataBitSet2ConsentOptionsBitSet(e){let t=0;for(const r in e)e[r]&&(t|=1<<Number(r));return t}onLoad(){var e;if(window.__tcfapi){null===(e=this.logger)||void 0===e||e.log(`${this.getName()}::onLoad()`);const t=(e,t)=>{var r,i,s;t?"useractioncomplete"!==e.eventStatus&&"tcloaded"!==e.eventStatus||(this.consentIsLoaded=!0,this.consentsBitSet=this.tcfDataBitSet2ConsentOptionsBitSet(null!==(i=e.purpose.consents)&&void 0!==i?i:{}),this.legitimateInterestsBitSet=this.tcfDataBitSet2ConsentOptionsBitSet(null!==(s=e.purpose.legitimateInterests)&&void 0!==s?s:{}),this.dispatchConsentChanged(this.consentsBitSet,this.legitimateInterestsBitSet)):null===(r=this.logger)||void 0===r||r.warn(`${this.getName()}::onLoad::updateConsentCallback:!success`)};window.__tcfapi("addEventListener",2,t)}}dispatchConsentChanged(e,t){for(let r=0;r<this.onConsentChangedHandlers.length;r++)this.onConsentChangedHandlers[r](e,t)}hasLoaded(){return this.consentIsLoaded}isConsentEditable(){return!0}loadConsentManagementPlatform(e){let t=1;const r=()=>{window.__tcfapi?this.onLoad():(setTimeout(r,t),t*=2,t>4e3&&(t=4e3))};r()}consentToTerms(){var e;null===(e=this.logger)||void 0===e||e.warn(`${this.getName()}::consentToTerms(NoOpImpl)`)}onConsentChanged(e){this.onConsentChangedHandlers.push(e),this.consentIsLoaded&&e(this.consentsBitSet,this.legitimateInterestsBitSet)}hasConsentForAny(t,r=e.ConsentOptions.None){return this.hasLoaded()&&0!=(this.consentsBitSet&t)}hasConsentForAll(t,r=e.ConsentOptions.None){return this.hasLoaded()&&(this.consentsBitSet&t)==t}consents(){return this.consentsBitSet}legitimateInterests(){return this.legitimateInterestsBitSet}}class de{constructor(e){this.decode(e)}getRightmost1Index(){return this.bits.lastIndexOf("1")}is1AtIndex(e){return e>=0&&"1"===this.bits.substr(e,1)}set1AtIndex(e){this.bits=this.bits.substr(0,e)+"1"+this.bits.substr(e+1)}decode(e){return/^0x[a-f0-9]*$/i.test(e)||(e="0x"+(Number(e)||0).toString(2).split("").reverse().join("").toString()),e=e.substring(2),this.bits=e.split("").map((function(e){let t=parseInt(e,16).toString(2);for(;t.length<4;)t="0"+t;return t})).join("")}encode(){return"0x"+this.bits.match(/(.{1,4})/g).map((function(e){for(;e.length<4;)e+="0";return parseInt(e,2).toString(16)})).join("")}}class ce{constructor(){this.PLAY_SESSION_TIMEOUT=18e5,this.randomPageSessionId=oe(),this.randomPlaySessionId=oe(),this.randomGlobalUserId=oe(),this.randomPlaySessionIdTimeStamp=Date.now()}init(){return r(this,void 0,void 0,(function*(){}))}getName(){return"random"}getUserSource(){return e.AnalyticsIDProviderStorageType.IN_MEMORY}getPageSessionId(){return this.randomPageSessionId}getPlaySessionId(){return this.randomPlaySessionIdTimeStamp+this.PLAY_SESSION_TIMEOUT<Date.now()&&(this.randomPlaySessionId=oe()),this.randomPlaySessionIdTimeStamp=Date.now(),this.randomPlaySessionId}getGlobalUserId(){return this.randomGlobalUserId}}class he{constructor({analyticsProviders:e,idProvider:t,consentProvider:r,contextProvider:i,storage:o,logger:n,appContextFields:a}={}){this.ANALYTICS_STORAGE_KEY="__frvr_analytics_storage",this.FTUE_STEPS_DONE_KEY="__frvr_ftue_steps_done",this.data={},this.extraFieldFunctions=[],this.MAX_PRE_CONSENT_LOAD_EVENT_QUEUE=100,this.preConsentLoadEventQueue=[],this.randomIdProvider=new ce,this.qatoolEnabled=!1,this.analyticsProviders=null!=e?e:[],this.idProvider=null!=t?t:ie,this.consentProvider=null!=r?r:new ae,this.storage=null!=o?o:c,this.logger=null!=n?n:s,this.contextProvider=i,this.timeStart=Date.now(),this.appContextFields=null!=a?a:{},this.qatoolEnabled=new URLSearchParams(window.location.search).has("qatoolEnabled")}loadStorage(){return r(this,void 0,void 0,(function*(){this.data=yield this.storage.getItem(this.ANALYTICS_STORAGE_KEY,{})}))}updateStorage(){this.storage.setItem(this.ANALYTICS_STORAGE_KEY,Object.assign({},this.data))}getContextFields(){const e=this.data.game_start_time,t=Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},this.appContextFields),this.contextProvider(this)),this.getConsentContextFields()),{page_session_id:this.getConsentedIdProvider().getPageSessionId(),play_session_id:this.getConsentedIdProvider().getPlaySessionId()}),this.data),{game_duration:void 0!==e?-1===e?0:Date.now()-e:void 0,loading_time:void 0===this.timeLoaded?void 0:this.timeLoaded-this.timeStart});for(const e of this.extraFieldFunctions)e(t);return t}dispatchOutstandingEvents(){const e=this.preConsentLoadEventQueue;for(;e.length>0;){const{event:t,value:r,fields:i,context:s,requiredConsents:o,requiredLegitimateInterests:n}=e.shift();this.dispatchEvent(t,r,i,Object.assign(Object.assign({},s),this.getConsentContextFields()),o,n)}}dispatchEvent(e,t,r,i,s,o){for(const n of this.analyticsProviders)try{(this.consentProvider.hasConsentForAll(s,o)||this.qatoolEnabled&&"post-message"===n.getName())&&n.send(e,t,r,i)}catch(e){this.logger.error(`[frvr-tracker] error sending event via provider ${n.getName()}`,e)}}getConsentContextFields(){return{cmp_consents:this.consentProvider.consents(),cmp_legitimateInterests:this.consentProvider.legitimateInterests()}}send(e,t,r,i,s){const o=this.getContextFields();for(const e in r)void 0===r[e]&&delete r[e];for(const e in o)void 0===o[e]&&delete o[e];this.logger.log("[frvr-tracker] event",e,r,o),this.consentProvider.hasLoaded()||this.qatoolEnabled?(this.dispatchOutstandingEvents(),this.dispatchEvent(e,t,r,Object.assign(Object.assign({},o),this.getConsentContextFields()),i,s)):this.preConsentLoadEventQueue.length<this.MAX_PRE_CONSENT_LOAD_EVENT_QUEUE&&this.preConsentLoadEventQueue.push({event:e,value:t,fields:r,context:o,requiredConsents:i,requiredLegitimateInterests:s})}init(){return r(this,void 0,void 0,(function*(){!function(e){const t=window.onerror;window.onerror=(r,i,s,o,n)=>{if(t)try{t(r,i,s,o,n)}catch(e){}if(r=String(r),n=n||new Error(r))try{e({msg:r,line:s,col:o,label:n.stack||JSON.stringify(n)})}catch(e){}return!1};const r=window.onunhandledrejection?window.onunhandledrejection.bind(window):null;window.onunhandledrejection=t=>{if(r)try{r(t)}catch(e){}try{const r=t&&t.reason||{};e({msg:r.message,line:0,col:0,label:"unhandled_rejection: "+(r.stack||JSON.stringify(r))})}catch(e){}}}((t=>this.logEvent("error",t,e.ConsentOptions.None))),yield this.loadStorage(),yield Promise.all([this.idProvider.init(),this.randomIdProvider.init()]),yield Promise.all(this.analyticsProviders.map((e=>e.init(this.consentProvider,this))))}))}loaded(){this.timeLoaded=Date.now(),this.logEvent("game_loaded",{},e.ConsentOptions.P10DevelopAndImproveProducts)}set(e,t){return this.data[e]=t,this.updateStorage(),t}inc(e,t){const r=(this.data[e]||0)+(void 0===t?1:t);return this.set(e,r),r}logEvent(t,r,i=e.ConsentOptions.None,s=e.ConsentOptions.None){this.send(t,void 0,r,i,s)}logValuedEvent(t,r,i,s=e.ConsentOptions.None,o=e.ConsentOptions.None){this.send(t,r,i,s,o)}logDiscoveryPageView(t){this.send("discovery_page_view",void 0,t,e.ConsentOptions.None,e.ConsentOptions.None)}getPlaySessionId(){return this.getConsentedIdProvider().getPlaySessionId()}getGlobalUserId(){return this.getConsentedIdProvider().getGlobalUserId()}getUserSource(){return this.getConsentedIdProvider().getUserSource()}addExtraFieldFunction(e){return this.extraFieldFunctions.push(e),()=>{const t=this.extraFieldFunctions.indexOf(e);-1!==t&&this.extraFieldFunctions.splice(t,1)}}ftue(t,r,i){const s=new de(this.data.ftuestepsdone);if(t<=s.getRightmost1Index())return void this.logger.warn("[frvr-tracker] ftue:",`step ${t} (${r}) has already been tracked`);s.set1AtIndex(t),this.set("ftuestepsdone",s.encode());const o=Object.assign(Object.assign({},i),{step_number:t,step_name:r});this.logEvent("ftue",o,e.ConsentOptions.P6PersonalizedContent|e.ConsentOptions.P5PersonalizedContentProfile|e.ConsentOptions.P8MeasureContentPerformance|e.ConsentOptions.P9MarketResearchForAudienceInsights|e.ConsentOptions.P10DevelopAndImproveProducts)}ftueUnordered(t,i,s){return r(this,void 0,void 0,(function*(){const r=yield this.storage.getItem(this.FTUE_STEPS_DONE_KEY,[]);if(r.find((e=>e===t)))return void this.logger.warn("[frvr-tracker] ftue:",`step ${t} (${i}) has already been tracked`);r.push(t),this.storage.setItem(this.FTUE_STEPS_DONE_KEY,r);const o=Object.assign(Object.assign({},s),{step_number:t,step_name:i});this.logEvent("ftue",o,e.ConsentOptions.P6PersonalizedContent|e.ConsentOptions.P5PersonalizedContentProfile|e.ConsentOptions.P8MeasureContentPerformance|e.ConsentOptions.P9MarketResearchForAudienceInsights|e.ConsentOptions.P10DevelopAndImproveProducts)}))}levelStart(t,r){const i=Object.assign(Object.assign({},r),{level_id:t});this.set("game_start_time",Date.now()),this.inc("games_played");const s=function(){const e=new Date;return e.getUTCFullYear()+"-"+se(e.getUTCMonth()+1)+"-"+se(e.getUTCDate())}();this.data.last_day_played!==s&&(this.set("last_day_played",s),this.inc("days_played"));const o=this.inc("play_session_count");this.logValuedEvent("game_play_start",o,i,e.ConsentOptions.P8MeasureContentPerformance|e.ConsentOptions.P10DevelopAndImproveProducts)}levelEnd(t,r){const i=Object.assign(Object.assign({},r),{level_id:t});this.logEvent("game_end",i,e.ConsentOptions.P8MeasureContentPerformance|e.ConsentOptions.P10DevelopAndImproveProducts),this.set("game_start_time",-1)}getConsentedIdProvider(){return this.consentProvider.hasConsentForAll(e.ConsentOptions.P1StoreInformationOnADevice,e.ConsentOptions.None)?this.idProvider:this.randomIdProvider}}const le={chromeWrapper:"chromeos",androidWrapper:"android",iOSWrapper:"ios",rcs:"rcs",samsungAppStore:"samsung_galaxy_store",facebookInstant:"facebook_instant",facebookRooms:"facebook_rooms",facebookAppWeb:"facebook_canvasweb",facebookApp:"facebook_canvas",samsungBixby:"bixby",samsungGameLauncher:"samsung_game_launcher",samsungInstantPlay:"samsung_instant_play",spilGamesWrapper:"spil",vkru:"vkru",okru:"okru",kik:"kik",twitter:"twitter",twitch:"twitch",hago:"hago",oppoGlobal:"oppo_global",tMobile:"tmobile",huawei:"huawei",huaweiquickapp:"huawei_quick_app",yandex:"yandex",crazyGames:"crazy_games",lgtv:"lg_tv",jioStb:"jio_stb",myJio:"jio_my",jioGameslite:"jio_gameslite",rocketChat:"rocket_chat",ufone:"ufone",game8:"game8",mailonline:"mail_online",discord:"discord",harman:"harman",microsoftPwa:"microsoft_pwa"},ue="frvr",ge={7978894035:"samsung_game_launcher",7640790291:"bixby",3704760038:"legacy_samsung_daily",4056808137:ue,3238562380:"samsung_instant_play",5374938192:ue,5362404538:ue,9165482691:ue,1661744930:ue,1781508157:ue,1526015108:"legacy_samsung_browser_us",9152813246:"legacy_samsung_gl_fallback",1570234097:"bixby",6159024522:"telenorpk",9547456458:"huawei_quick_app",4901070532:ue,5509479103:ue,4687607673:ue,7772201439:ue,5781080938:ue,7859627468:"bixby",6225636036:ue,9257964653:ue,9997971842:"legacy_samsung_gl_pwa",1810535265:ue,6879406107:ue,5664912848:ue,7871893264:"oppo_global",6905222938:"1001spill",1074763396:ue,4822698373:"huawei",3917207338:ue,3091839955:ue,9511672440:ue,9609759920:ue,8846287731:ue,1912410415:ue,3463089052:ue,3138478138:"spil",3609613151:ue,7259516105:ue,8260783143:ue,4791934430:ue,5304245228:ue,4196077731:ue,7517011737:"ga",1420430092:ue,6341560802:ue,3188724532:ue,7430391555:"samsung_galaxy_store_pwa",6142190935:ue,2410146e3:"spil",6238202936:ue,2165771095:ue,7169566203:ue,7116648941:ue,9484119302:ue,8289067739:"crazy_games",4942292965:ue,4111954147:"samsung_instant_daily",9508446909:"mozilla_lite",6581072258:ue,6305391737:ue,7721350107:ue,5689634745:ue,4407671492:ue,8793151713:"mynet",6701854007:ue,8166612510:ue,1204043211:ue,8540348735:ue,8092992494:ue,3050063345:ue,6105016100:ue,5383746593:ue,2155121367:ue,4481639214:ue,9167804042:ue,2633738716:ue,5732840388:ue,1136474154:ue,3868538934:ue,6791411817:ue,4001058104:"spil",8323344707:ue,1511956590:ue,5337609782:ue,7647348124:ue,9465676615:ue,8699389853:ue,8288405339:"ga",1601204168:ue,6738957149:ue,3143968130:"spil",3660984936:"legacy_all_samsung_browser",6672071330:"ga",9944902462:ue,4216099801:"ga",9810477030:ue,4127083129:ue,9831349735:"mediatrust",1651142765:ue,2402315798:ue,3217022605:"rcs",8209630496:ue,7348809119:ue,1907949320:ue,7711130568:ue,6682900564:ue,8220757253:ue,9226003469:ue,6459119768:"ga",3297429215:ue,2066412442:ue,9610826637:"spil",5428378892:ue,3718604937:"ga",7010263033:ue,5533541335:"spil",5393940535:"spil",6680931602:ue,8135642444:ue,5195338130:"ga",2443106993:ue,9841433446:ue,9471076165:"spil",8645981334:"clickjogos",9750454053:"spil",5496116299:"spil",9095657336:"spil",5196972230:ue,1711991335:"spil",1463804937:"plonga",6650691459:ue,7854536931:"spil",4185858062:ue,1559694722:ue,4196397436:"ga",5791200697:ue,8838890658:ue,6592001260:ue,8990371880:"rocketchat",3078524176:ue,1414057592:"spil",1721816412:"spil",7627870781:"samsung_instant_browser_us",7257814137:"spil",6687910134:"mfogs",6388800833:ue,6794212012:"mailonline",2719344539:"spil",6005657456:ue,4761469737:"spil",8260978605:ue,4899645641:ue,5570875049:"tron",3275762232:"spil",1433925895:"spil",7925670440:"taboola",3587369568:"squid",3982547231:ue,4388062450:"spil",8471269857:"bixby",1323020937:"spil",3605255281:"bixby",9085283107:ue,1873844328:"legacy_samsung_browser_m4s",8924310391:"bixby",7269966843:"tmobile",1075554580:"adsenseforgamestest2",1098459098:ue,8199816817:"xiaomi"},ve=window.location.href;const pe=function(e,t){let r="frvr";for(const t in le)e[t]&&(r=le[t]);const i=t();if(i){const e=ge[i];e&&(r=e)}return(window.location&&window.location.host&&"krunker.io"===window.location.host||"internal.krunker.io"===window.location.host)&&(r="krunker_io"),window.location&&window.location.host&&window.location.host.includes("discord")&&(r="discord"),r},me=function(e,t){null!=e||(e=window.location.href),t=t.replace(/[\[\]]/g,"\\$&");const r=new RegExp("[?&]"+t+"(=([^&#]*)|&|#|$)","i").exec(e);return r?r[2]?decodeURIComponent(r[2].replace(/\+/g," ")):"":null},fe=(e,t)=>function(r,i,s,o){const n={};return e&&(n[e]=!0),n.android=/(android)/i.test(s)&&!/(Windows)/i.test(s),n.androidVersion=function(){const e=navigator.userAgent.toLowerCase().match(/android\s([0-9\.]*)/);return parseFloat(e?e[1]:"0")}(),n.firefoxMobile=/(Mobile)/i.test(s)&&/(Firefox)/i.test(s),n.slow=n.android&&n.androidVersion<6,n.iOS=/(ipod|iphone|ipad)/i.test(s)||/(Macintosh)/i.test(s)&&"ontouchend"in document,n.windowsMobile=/(IEMobile)/i.test(s),n.silk=/(silk)/i.test(s),n.clay=/(clay\.io)/i.test(o),n.facebookApp=/(fb_canvas)/i.test(o),n.facebookAppWeb=/(fb_canvas_web)/i.test(o),n.iframed=r.top!==r.self,n.standalone="standalone"in i&&i.standalone,n.mobileiOSDevice=Boolean(s.match(/iPhone/i)||s.match(/iPod/i)),n.kongregate=/(kongregateiframe)/i.test(o),n.kik=/(kik_canvas)/i.test(o),n.twitter=/(twitter)/gi.test(s),n.chrome=/Chrome\//.test(s),n.safari=!!navigator.userAgent.match(/Version\/[\d\.]+.*Safari/),n.secureConnection=0==window.location.protocol.indexOf("https"),n.facebookInstant=!!window.FBInstant,n.facebookRooms=!!window.isFacebookRooms,n.spilGamesWrapper=/(spilgames)/i.test(o),n.social="on"==me(t,"social"),n.advertisementIsDisabled="off"==me(t,"ads"),n.advertisementInterstitialDisabled="off"==me(t,"int"),n.advertisementOverlayEnabled=!n.iframed||n.spilGamesWrapper||Boolean(me(t,"partnerid")),n.nosoc="1"==me(t,"nosoc"),n.facebookAd=/(\/\?fb)/i.test(o),n.mobile=n.android||n.windowsMobile||n.iOS||n.silk||n.firefoxMobile,n.iOSWrapper=!!r.iOSWrapper,n.iPhoneXOrLater="true"==me(t,"iPhoneXOrLater"),n.iMessageContext="true"==me(t,"iMessage"),n.androidWrapper=!!r.androidWrapper,n.chromeWrapper=!!r.isChromeWrapper,n.samsungAppStore="samsung"==me(t,"androidStore"),n.appWrapper=Boolean(r.iOSWrapper||r.androidWrapper||n.samsungAppStore),n.usingWebGLRenderer=!1,n.usingCanvasRenderer=!1,n.jioStb=!!n["jio-stb"],n.myJio=!!n.myjio,n.jioGameslite=!!n["jio-gameslite"],n.jio=n.jioStb||n.myJio||n.jioGameslite,n.twitch=""==me(t,"twitch"),n.vkru=""==me(t,"vkru"),n.okru=""==me(t,"okru"),n.tMobile=""==me(t,"tmobile"),n.pwa=""==me(t,"pwa"),n.windowsApp=""==me(t,"windowsapp"),n.enableAppStoreLinks=!0,n.samsungGalaxyStorePWA=""==me(t,"samsung")&&"galaxystore"==me(t,"source"),n.samsungGameLauncherPWA=(""==me(t,"pwa")||""==me(t,"samsung"))&&"gamelauncher"==me(t,"source"),n.samsungGameLauncher=!!window.FRVRInstant||(""==me(t,"gamelauncher")||"gamelauncher"==me(t,"source")),n.samsungBixby=""==me(t,"samsung")&&!n.samsungGalaxyStorePWA,n.samsungBrowserUK=""==me(t,"samsungbuk"),n.samsungBrowserUS=""==me(t,"samsungbus"),n.samsungBrowserSEA=""==me(t,"samsungbsea"),n.samsungBrowser=""==me(t,"samsungbrowser"),n.samsungGLFallback=""==me(t,"gl_fallback"),n.samsungInstantPlay=!!window.GSInstant,n.samsung=n.samsungGalaxyStorePWA||n.samsungGameLauncherPWA||n.samsungGameLauncher||n.samsungBixby||n.samsungBrowserUK||n.samsungBrowserUK||n.samsungBrowserUS||n.samsungBrowserSEA||n.samsungBrowser||n.samsungGLFallback||n.samsungInstantPlay,n.rcs=Boolean(me(t,"rcsid")),n.rcsKr=""==me(t,"rcskr"),n.huaweiquickapp=""==me(t,"huaweiquickapp"),n.huawei=""==me(t,"huawei")||n.huaweiquickapp,n.mozilla=""==me(t,"mozilla"),n.miniclip=""==me(t,"miniclip"),n.chromeOSDevice="true"==me(t,"isChromeOSDevice"),n.opera=!!r.opr&&!!r.opr.addons||!!r.opera||s.indexOf(" OPR/")>=0,n.yandex=!!window.YaGames,n.firefox=void 0!==r.InstallTrigger,n.edge=/(edge|edgios|edga)\/((\d+)?[\w\.]+)/i.test(s),n.oppoGlobal=""==me(t,"oppo"),n.lgtv=""==me(t,"lgtv"),n.crazyGames="8289067739"==me(t,"partnerid"),n.mynet=""==me(t,"mynet"),n.ufone="8416254215"==me(t,"partnerid"),n.game8=""==me(t,"game8"),n.mailonline="6794212012"==me(t,"partnerid"),n.disableNativeBridge=""==me(t,"disableNativeBridge"),n.partnerWrapper=!n.disableNativeBridge&&(n.mynet||n.tMobile||n.ufone||n.mailonline)&&(n.iOS||n.android),n.rocketChat=""==me(t,"rocketchat"),n.discord="discord"===e,n.harman=""==me(t,"harman"),n.progressiveWebAppEnabled=!(n.chromeOSDevice||n.iframed||n.appWrapper||n.twitch||n.vkru||n.okru||n.facebookInstant||n.partnerWrapper),n.tv=n.jioStb||n.lgTV,n.microsoftPwa=""==me(t,"mspwa")||!!me(t,"msstart_sdk_init"),n}(window,navigator,navigator.userAgent,String(window.location));const ye={getChannel:function(e,t,r){let i,s;return()=>{if(i)return i;var o,n,a;null!=s||(s=fe(e,ve)),null!=r||(o=ve,n=s,a=t||{},r=()=>function(e,t,r){const i=me(e,"partnerid");if(i)return i;const s=[["samsungBrowser","3660984936"],["rcs","3217022605"],["huaweiquickapp","9547456458"],["huawei","4822698373"],["tMobile","7269966843"],["miniclip","8532226134"],["samsungBrowserSEA","2765561693"],["samsungBrowserUS","1526015108"],["samsungBrowserUK","2961002817"],["mozilla","9508446909"],["samsungBixby","7640790291"],["samsungGalaxyStorePWA","7430391555"],["samsungGameLauncherPWA","9997971842"],["samsungInstantPlay","3238562380"]];for(const[e,r]of s)if(t[e])return r;const o={ft_daily:"4111954147",ft_bixby:"7859627468",ft_browser_us:"7627870781",ft_browser_uk:"8436188448",default:"7978894035"},n={ft_daily:"3704760038",ft_bixby:"7640790291",ft_browser_us:"1526015108",ft_browser_uk:"2961002817",default:"9152813246"};return t.samsungGameLauncher?o[me(e,"source")]||o.default:me(e,"gl_fallback")||""===me(e,"gl_fallback")?n[me(e,"source")]||n.default:t.spilGamesWrapper&&r.googleAdSpilgamesId?r.googleAdSpilgamesId:!!r.googleAdSiteId&&r.googleAdSiteId}(o,n,a));const d=pe(s,r);return i=d,d}}("",{})},Ie={getName:()=>"Empty Provider",init:()=>r(void 0,void 0,void 0,(function*(){})),configure:()=>r(void 0,void 0,void 0,(function*(){})),isReady:()=>!1,getCatalog:()=>({}),getProductById:()=>{},purchase:()=>r(void 0,void 0,void 0,(function*(){throw new Error("no products")})),consumePurchase:()=>{throw new Error("no products")},getUnconsumedPurchases:()=>r(void 0,void 0,void 0,(function*(){return[]})),onIsReadyChanged:function(){}},Pe={logEvent:()=>{},logValuedEvent:()=>{}};class Se{constructor(e,t){this.analytics=e,this.providerName=t}logRequestPaymentError(e,t){this.analytics.logValuedEvent("iap_request_payment_failed",1,Object.assign(Object.assign({},e),{err:t}))}logRequestPaymentSuccess(e,t){this.analytics.logValuedEvent("iap_request_payment_success",1,Object.assign(Object.assign({},e),{purchaseId:t.purchaseId}))}logRequestPayment(e){this.analytics.logValuedEvent("iap_request_payment",1,Object.assign({},e))}logConsumePurchase(e,t){this.analytics.logValuedEvent("iap_consume_purchase",1,Object.assign(Object.assign({},e),{purchaseId:t.purchaseId}))}logRestorePurchasesError(e){this.analytics.logValuedEvent("iap_request_restore_purchase_error",1,{provider:this.providerName,err:e})}logRestorePurchasesSuccess(){this.analytics.logValuedEvent("iap_request_restore_purchase_success",1,{provider:this.providerName})}logRestorePurchases(){this.analytics.logValuedEvent("iap_request_restore_purchase",1,{provider:this.providerName})}}var Ee;e.IAPErrorCode=void 0,(Ee=e.IAPErrorCode||(e.IAPErrorCode={})).UNKNOWN="UNKNOWN",Ee.USER_INPUT="USER_INPUT",Ee.INVALID_PARAM="INVALID_PARAM";class be extends Error{constructor(t,r,i=e.IAPErrorCode.UNKNOWN){super(t,r),this.code=i,Object.setPrototypeOf(this,be.prototype)}}class _e extends be{constructor(t,r){super(t,r,e.IAPErrorCode.INVALID_PARAM),Object.setPrototypeOf(this,_e.prototype)}}class Ae extends be{constructor(t="Purchase cancelled by user",r){super(t,r,e.IAPErrorCode.USER_INPUT),Object.setPrototypeOf(this,Ae.prototype)}}var Te=Object.freeze({__proto__:null,get IAPErrorCode(){return e.IAPErrorCode},IAPError:be,IAPPurchaseErrorUnknownProduct:_e,IAPPurchaseErrorCancelledByUser:Ae});class Re{constructor(e){this.errors=Te,this.provider=e.provider||Ie,this.iapTracker=new Se(e.tracker||Pe,this.provider.getName()),this.logger=e.logger||s}init(){return this.provider.init()}configure(e){return this.provider.configure(e)}isReady(){return this.provider.isReady()}onReady(e){this.provider.onIsReadyChanged(e)}getProviderName(){return this.provider.getName()}getCatalog(){return this.provider.getCatalog()}getProductById(e){var t;const r=this.provider.getProductById(e);if(!r)return void this.logger.error("IAP. Product not found",e);const i=null!==(t=r.price)&&void 0!==t?t:`${r.currencyCode} ${r.priceValue}`;return Object.assign(Object.assign({},r),{price:i,provider:this.provider.getName(),productId:e})}purchase(e,t){return r(this,void 0,void 0,(function*(){const r=this.getProductById(e);if(this.iapTracker.logRequestPayment(r),!r)throw new _e(`Unknown product "${e}"`);try{const i=yield this.provider.purchase(e,t);return this.iapTracker.logRequestPaymentSuccess(r,i),i}catch(e){const t=e.message||e.toString();if(this.iapTracker.logRequestPaymentError(r,t),e instanceof Ae)throw this.logger.log("Purchase cancelled by user"),e;throw this.logger.error("Error in purchase: "+t,e),new be("Unexpected purchase error",{cause:e})}}))}consumePurchase(e){return r(this,void 0,void 0,(function*(){const t=this.getProductById(e.productId);this.iapTracker.logConsumePurchase(t,e);try{yield this.provider.consumePurchase(e)}catch(e){throw new be("Unexpected consume error",{cause:e})}return e.purchaseId}))}getUnconsumedPurchases(){return r(this,void 0,void 0,(function*(){this.iapTracker.logRestorePurchases();try{const e=yield this.provider.getUnconsumedPurchases();return this.iapTracker.logRestorePurchasesSuccess(),e}catch(e){const t=e.message||e.toString();this.iapTracker.logRestorePurchasesError(t),this.logger.error("Error in getUnconsumedPurchases: "+t,e)}return[]}))}requestPayment(e,t){return this.purchase(e,t)}restorePurchases(){return this.getUnconsumedPurchases()}getPurchases(){return this.getUnconsumedPurchases()}}class Ce{constructor(t){var r;this.auth=t.auth,this.channelId=t.channelId,this.gameId=t.gameId,this.apiHost=null!==(r=t.apiHostOverride)&&void 0!==r?r:t.env===e.Env.PRODUCTION?"https://crucible.frvr.com/v1/iap":"https://staging.crucible.frvr.com/v1/iap"}fetch(e,t){return this.auth.authenticatedFetch(`${this.apiHost}/${this.channelId}/${e}`,t)}getPurchases(){return this.auth.authenticatedFetch(`${this.apiHost}/purchases/${this.auth.getFRVRID()}`,{method:"GET",body:"{}"}).then(this.validateAndReturnJSON)}validatePurchase(e,t={}){return this.auth.authenticatedFetch(`${this.apiHost}/validate/${this.channelId}/${this.gameId}`,Object.assign({method:"POST",body:JSON.stringify(e)},t)).then(this.validateAndReturnJSON)}consumePurchase(e,t){return this.auth.authenticatedFetch(`${this.apiHost}/consume/${this.channelId}/${this.gameId}`,{method:"POST",body:JSON.stringify({applicationId:e,transactionId:t})}).then(this.validateAndReturnJSON)}getProducts(){return fetch(`${this.apiHost}/products/${this.channelId}/${this.gameId}`,{method:"GET"}).then(this.validateAndReturnJSON)}validateAndReturnJSON(e){if(!e.ok)throw new Error(`IAPServiceClient bad response: ${e.status} ${e.statusText}`);return e.json()}}class we{scheduleMessage(e){return r(this,void 0,void 0,(function*(){const t=yield fetch("https://hermes.frvr.com/v1/scheduler",{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(e)});return yield t.json()}))}}const Oe={logEvent:()=>{}};class ke{constructor({provider:e,logger:t,tracker:r=Oe}){this.initialized=!1,this.provider=e,this.logger=t,this.chatbot=new we,this.tracker=r}init(){return r(this,void 0,void 0,(function*(){this.game?this.initialized=!0:this.logger.error("Notifications class should be configured before it is initialized")}))}configure(e){return r(this,void 0,void 0,(function*(){this.game=e.game}))}scheduleMessage(e){return r(this,void 0,void 0,(function*(){if(!this.initialized)throw this.logger.error("Chatbot can not be used until it has been initialized"),new Error("INVALID_OPERATION");const t={game:this.game,platform:this.provider.getName(),player_id:e.playerId,timetorun:e.delayInSeconds,template:{image_url:e.imageUrl,message:e.message,buttons:e.buttons}};return yield this.chatbot.scheduleMessage(t)}))}canScheduleMessages(){return this.provider.canScheduleMessages()}subscribeScheduleMessages(){return this.tracker.logEvent("bot_subscribe_show",{}),this.provider.subscribeScheduleMessages().then((e=>(e?this.tracker.logEvent("bot_subscribe_success",{}):this.tracker.logEvent("bot_subscribe_failure",{}),e))).catch((e=>(this.tracker.logEvent("bot_subscribe_failure",{}),!1)))}scheduleLocalNotification(e,t,r,i){return this.provider.scheduleLocalNotification(e,t,r,i)}}function Le(){this.code="INVALID_OPERATION",this.message="Trying to use an empty interface."}const Ne={getName:()=>"",canScheduleMessages(){return r(this,void 0,void 0,(function*(){return!1}))},subscribeScheduleMessages(){return r(this,void 0,void 0,(function*(){return!1}))},scheduleLocalNotification:()=>Promise.reject(new Le)};class Fe{constructor({id:e,contextID:t,endTime:r,startTime:i,title:s,payload:o,offset:n,players:a,type:d,count:c}){this.id=e,this.contextID=t,r&&(this.endTime=r),i&&(this.startTime=i),this.title=s,this.payload=o,this.offset=n,this.count=c,a&&(this.players=a),d&&(this.type=d)}}class De{constructor(e){this.id=e.id,this.name=e.name,this.photo=e.photo,this.rank=e.rank,e.updated&&(this.updated=e.updated),this.score=e.score,this.payload=e.payload}}const Ue="TOURNAMENT",Ve={[e.Env.PRODUCTION]:"https://crucible.frvr.com",[e.Env.BETA]:"https://staging.crucible.frvr.com",[e.Env.DEVELOPMENT]:"https://staging.crucible.frvr.com"};class xe{constructor(e){this.channel=e}init(e,t){this.apiUrl=Ve[t],this.gameId=e,this.leaderboards={}}createLeaderboard(e,t){return r(this,void 0,void 0,(function*(){const r=`${this.apiUrl}/v1/leaderboards`,i={game:this.gameId,title:t.title,endTime:t.endTime,type:e||"default",data:t.payload,sortOrder:t.sortOrder||"HIGHER_IS_BETTER"};t.id&&(i.id=t.id);const s=yield fetch(r,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)}),o=yield s.json();if(!s.ok)throw new Error(o.error.message);return o.id}))}getLeaderboard(e,t=30,i=0){return r(this,void 0,void 0,(function*(){const r=`${this.apiUrl}/v1/leaderboards/${this.gameId}/${e}`,s={count:t.toString(),offset:i.toString()},o=yield fetch(r+"?"+new URLSearchParams(s)),n=yield o.json();if(!o.ok)throw new Error(n.error.message);n.payload=n.data;const a=n.players?n.players.map((t=>{const r=new De(t);return r.score=this.cacheScore(e,r.id,r.score),r})):[];return n.players=a,new Fe(n)}))}getLeaderboardEntry(e,t){return r(this,void 0,void 0,(function*(){const r=`${this.apiUrl}/v1/leaderboards/${this.gameId}/${e}/${t}`,i={platform:this.channel},s=yield fetch(r+"?"+new URLSearchParams(i)),o=yield s.json();if(!s.ok)throw new Error(o.error.message);return o.payload=o.data,o.score=this.cacheScore(e,t,o.score),new De(o)}))}submitScore(e,t,i,s,o){return r(this,void 0,void 0,(function*(){this.cacheScore(e,t,i);const r=`${this.apiUrl}/v1/leaderboards/${this.gameId}/${e}`,n={id:t,score:i,platform:this.channel};s&&(n.name=s),o&&(n.photo=o);const a=yield fetch(r,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}),d=yield a.json();if(!a.ok)throw new Error(d.error.message);return d}))}getAllLeaderboardsIdsOfType(e){return r(this,void 0,void 0,(function*(){return(yield this.getAllLeaderboardsOfType(Object.assign(Object.assign({},e),{verbose:!1}))).ids||[]}))}getAllLeaderboardsDataOfType(e){return r(this,void 0,void 0,(function*(){return(yield this.getAllLeaderboardsOfType(Object.assign(Object.assign({},e),{verbose:!0}))).leaderboards||[]}))}getLeaderboardEntries(e,t){return r(this,void 0,void 0,(function*(){if(!t.length)return[];const r=`${this.apiUrl}/v1/leaderboards/${this.gameId}/${e}/entries`,i={platform:this.channel,players:t.join(",")},s=yield fetch(r+"?"+new URLSearchParams(i)),o=yield s.json();if(!s.ok)throw new Error(o.error.message);return((null==o?void 0:o.entries)||[]).map((t=>(t.payload=t.data,t.score=this.cacheScore(e,t.id,t.score),new De(t))))}))}getAllLeaderboardsOfType({type:e,playerId:t,sortBy:i="created",sortOrder:s="desc",count:o=30,offset:n=0,verbose:a=!1}){return r(this,void 0,void 0,(function*(){const r=`${this.apiUrl}/v1/players/${this.gameId}/${t}`,d={type:e,platform:this.channel,sortOrder:s,sortBy:i,count:o.toString(),offset:n.toString(),verbose:a?"true":"false"},c=yield fetch(r+"?"+new URLSearchParams(d)),h=yield c.json();if(!c.ok)throw new Error(h.error.message);return h}))}cacheScore(e,t,r){this.leaderboards[e]||(this.leaderboards[e]={scores:{}});const i=this.leaderboards[e].scores[t];return void 0!==i&&i>r&&(r=i),this.leaderboards[e].scores[t]=r,r}}var je;!function(e){e[e.create=0]="create",e[e.getCurrentTournament=1]="getCurrentTournament",e[e.getActiveTournaments=2]="getActiveTournaments",e[e.postScore=3]="postScore",e[e.join=4]="join",e[e.leave=5]="leave",e[e.share=6]="share",e[e.invitePlayers=7]="invitePlayers"}(je||(je={}));class Me{constructor(e){this.provider=e,this.API=je}isSupported(){return this.provider.isSupported()}isSupportedAPI(e){return-1!==this.provider.getSupportedAPIs().indexOf(e)}getSupportedAPIs(){return this.provider.getSupportedAPIs()}create(e,t,r){return this.provider.create(e,t,r)}getActiveTournaments(){return this.provider.getActiveTournaments()}getCurrentTournament(){return this.provider.getCurrentTournament()}join(e){return this.provider.join(e)}leave(){return this.provider.leave()}share(e,t){return this.provider.share(e,t)}invitePlayers(e){return this.provider.invitePlayers(e)}updateScore(e,t,r,i){return this.provider.postScore(e,t,r,i)}}class Be{constructor({provider:e,auth:t,logger:r,leaderboards:i}){this.provider=e,this.auth=t,this.logger=r,this.FRVRLeaderboards=i||new xe(this.provider.getLeaderboardsChannelId()),this.platform=new Me(this.provider)}init(e,t){this.FRVRLeaderboards.init(e,t)}create(e,t){return r(this,void 0,void 0,(function*(){if(this.provider.isSupported()&&this.provider.getSupportedAPIs().includes(je.create)){const r=yield this.provider.create(0,e,t);return yield this.ensureCreated(r),r.id}return yield this.FRVRLeaderboards.createLeaderboard(Ue,{payload:e,title:t.title,endTime:t.endTime,sortOrder:t.sortOrder})}))}postScore(e,t,i,s){return r(this,void 0,void 0,(function*(){const r=this.getPlayerId();if(!r)throw new Error("Player is not logged in");const o=[this.FRVRLeaderboards.submitScore(e,r,t,i,s)];this.provider.getSupportedAPIs().includes(je.postScore)&&o.push(this.provider.postScore(e,t,i,s)),yield Promise.allSettled(o)}))}getMyTournaments(e,t){return r(this,void 0,void 0,(function*(){const r=this.getPlayerId();if(!r)throw new Error("Player is not logged in");const i={type:Ue,count:e,offset:t,playerId:r};return this.FRVRLeaderboards.getAllLeaderboardsDataOfType(i)}))}getMyEntry(e){return r(this,void 0,void 0,(function*(){const t=this.getPlayerId();if(!t)throw new Error("Player is not logged in");return this.FRVRLeaderboards.getLeaderboardEntry(e,t)}))}getTournamentById(e,t,r){return this.FRVRLeaderboards.getLeaderboard(e,t,r)}ensureCreated(e){return r(this,void 0,void 0,(function*(){try{return void(yield this.FRVRLeaderboards.getLeaderboard(e.id))}catch(e){}yield this.FRVRLeaderboards.createLeaderboard(Ue,{id:e.id,payload:e.payload,title:e.title,endTime:e.endTime})}))}getPlayerId(){return this.auth.getFRVRID()}}const Ge={isSupported:()=>!1,getSupportedAPIs:()=>[],getLeaderboardsChannelId:()=>"empty",getCurrentTournament(){return r(this,void 0,void 0,(function*(){return null}))},create(){return r(this,void 0,void 0,(function*(){return null}))},postScore(){return r(this,void 0,void 0,(function*(){}))},share(){return r(this,void 0,void 0,(function*(){}))},getActiveTournaments(){return r(this,void 0,void 0,(function*(){return[]}))},join(){return r(this,void 0,void 0,(function*(){}))},leave(){return r(this,void 0,void 0,(function*(){}))},invitePlayers(){return r(this,void 0,void 0,(function*(){}))}};class $e{constructor({logger:e,provider:t}){this.logger=e,this.provider=t,this.platform=this.provider.platform}init(e,t,i){return r(this,void 0,void 0,(function*(){return this.gameId=e,yield this.provider.init(e,this.logger,t,i)}))}create(e,t){return this.provider.create(e,t)}challengeByContextId(e,t,r){return this.provider.challengeByContextId(e,t,r)}challengeByPlayerId(e,t,r){return this.provider.challengeByPlayerId(e,t,r)}getPossibleOpponents(){return this.provider.getPossibleOpponents()}getCurrentChallengeId(){return this.provider.getCurrentChallengeId()}getCurrentChallengeData(){return this.provider.getCurrentChallengeData()}leave(){return this.provider.leave()}getAllChallenges(e,t){return this.provider.getAllChallenges(e,t)}getPlayerEntries(e,t){return this.provider.getPlayerEntries(e,t)}getLeaderboardEntry(e,t){return this.provider.getLeaderboardEntry(e,t)}getLeaderboardById(e,t,r){return this.provider.getLeaderboardById(e,t,r)}postScore({score:e,challengeId:t,name:r,photo:i,playerId:s}){return this.provider.postScore({score:e,challengeId:t,name:r,photo:i,playerId:s})}join(e){return this.provider.join(e)}nudge(e,t){return this.provider.nudge(e,t)}getOpponentsFromChallenges(e){return this.provider.getOpponentsFromChallenges(e)}getChallengesByOpponents(){return this.provider.getChallengesByOpponents()}getEntryPayload(){return this.provider.getEntryPayload()}isSupported(){return this.provider.isSupported()}}var He;!function(e){e.getID="context.getID",e.getType="context.getType",e.isSizeBetween="context.isSizeBetween",e.switch="context.switchAsync",e.choose="context.chooseAsync",e.create="context.createAsync",e.getPlayers="context.getPlayersAsync",e.update="updateAsync"}(He||(He={}));const We={platform:{API:He,getSupportedAPIs:()=>[],isSupportedAPI:()=>!1,getID:()=>"",getType:()=>"SOLO",isSizeBetween:()=>({answer:!1,minSize:0,maxSize:0}),switch:()=>Promise.resolve(),choose:()=>Promise.resolve(),create:()=>Promise.resolve(),getPlayers:()=>Promise.resolve([]),update:()=>Promise.resolve()},init(){return r(this,void 0,void 0,(function*(){}))},create(){return r(this,void 0,void 0,(function*(){return""}))},challengeByPlayerId(){return r(this,void 0,void 0,(function*(){return""}))},getPossibleOpponents(){return r(this,void 0,void 0,(function*(){return[]}))},challengeByContextId(){return r(this,void 0,void 0,(function*(){return""}))},getCurrentChallengeData(){return r(this,void 0,void 0,(function*(){}))},leave(){return r(this,void 0,void 0,(function*(){}))},getCurrentChallengeId:()=>"",getPlayerEntries(){return r(this,void 0,void 0,(function*(){return[]}))},getAllChallenges(){return r(this,void 0,void 0,(function*(){}))},getLeaderboardEntry(){return r(this,void 0,void 0,(function*(){}))},getLeaderboardById(){return r(this,void 0,void 0,(function*(){}))},postScore(){return r(this,void 0,void 0,(function*(){}))},join(){return r(this,void 0,void 0,(function*(){}))},nudge(){return r(this,void 0,void 0,(function*(){}))},getOpponentsFromChallenges(){return r(this,void 0,void 0,(function*(){}))},getChallengesByOpponents(){return r(this,void 0,void 0,(function*(){}))},getEntryPayload:()=>({}),isSupported:()=>!1};class Ke{constructor({provider:e}){this.provider=e}init(e,t){this.provider.init(e,t)}isSupported(){return this.provider.isSupported()}getAllLeaderboards(){return this.provider.getAllLeaderboards()}getLeaderboardEntries(e,t){return this.provider.getLeaderboardEntries(e,t)}getLeaderboardEntry(e,t){return this.provider.getLeaderboardEntry(e,t)}getLeaderboard(e,t,r){return this.provider.getLeaderboard(e,t,r)}postScore(e,t){return this.provider.postScore(e,t)}}const qe={init(){},isSupported:()=>!1,getAllLeaderboards(){return r(this,void 0,void 0,(function*(){return[]}))},getLeaderboardEntries(){return r(this,void 0,void 0,(function*(){return[]}))},getLeaderboardEntry(){return r(this,void 0,void 0,(function*(){return{}}))},getLeaderboard(){return r(this,void 0,void 0,(function*(){return{}}))},postScore(){return r(this,void 0,void 0,(function*(){}))}},Ye={registrationSuccess:"registrationSuccess",registrationConflict:"registrationConflict",loginSuccess:"loginSuccess",accountNotActive:"accountNotActive",invalidCredentials:"invalidCredentials",invalidFormat:"invalidFormat",serverError:"serverError",unknownError:"unknownError",networkError:"networkError",operationSuccess:"operationSuccess",tokenExpired:"tokenExpired",notLoggedIn:"notLoggedIn",platformNotAvailable:"platformNotAvailable",platformLoginFail:"platformLoginFail,"},ze={REG_SUCCESS:{type:Ye.registrationSuccess,success:!0,message:"User registered successfully. Pending confirmation"},LOGIN_SUCCESS:{type:Ye.loginSuccess,success:!0,message:"Login successful"},OPERATION_SUCCESS:{type:Ye.operationSuccess,success:!0,message:"Operation success"},REG_CONFLICT:{type:Ye.registrationConflict,success:!1,message:"Email already registered"},ACCOUNT_NOT_ACTIVE:{type:Ye.accountNotActive,success:!1,message:"Provided credentials are valid but account is either not confirmed or suspended"},INVALID_CREDENTIALS:{type:Ye.invalidCredentials,success:!1,message:"Provided credentials are invalid"},INVALID_FORMAT:{type:Ye.invalidFormat,success:!1,message:"Invalid format on data"},SERVER_ERROR:{type:Ye.serverError,success:!1,message:"Error on server"},UNKNOWN_ERROR:{type:Ye.unknownError,success:!1,message:"Unknown error"},NETWORK_ERROR:{type:Ye.networkError,success:!1,message:"Network Error"},TOKEN_EXPIRED:{type:Ye.tokenExpired,success:!1,message:"Token has expired. Request a new challenge to get a fresh one"},NOT_LOGGED_IN:{type:Ye.notLoggedIn,success:!1,message:"Cannot perform operation without active login"},PLATFORM_NOT_AVAILABLE:{type:Ye.platformNotAvailable,success:!1,message:"The requested platform is not available"},PLATFORM_LOGIN_FAIL:{type:Ye.platformLoginFail,success:!1,message:"The login on the requested platform failed"}};var Je=Object.freeze({__proto__:null,RESPONSE_TYPES:Ye,default:Ye,RESPONSE_DEFINITIONS:ze});function Qe(e){if(!e)return null;const t=e.split(".");if(3!=t.length)return null;const r=t[1].replace(/-/g,"+").replace(/_/g,"/"),i=window.atob(r).split("").map((function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)})).join("");try{return JSON.parse(decodeURIComponent(i))}catch(e){return null}}class Xe{constructor(e,t){this.accessToken=e,this.refreshToken=t}set accessToken(e){var t;const r=Qe(e);r?(this._accessToken=e,this._accessPayload=r,this._accessExpiration=parseInt(null==r?void 0:r.exp,10)||0,this._accessIAT=parseInt(null==r?void 0:r.iat,10)||0,this._verified=!(!1===(null===(t=null==r?void 0:r.extra)||void 0===t?void 0:t.verified))):(this._accessToken=null,this._accessPayload=null,this._accessExpiration=0,this._accessIAT=0,this._verified=!1)}get accessToken(){return this._accessToken}set refreshToken(e){var t;const r=Qe(e);r?(this._refreshToken=e,this._refreshPayload=r,this._refreshExpiration=parseInt(null==r?void 0:r.exp,10),this._platform=null===(t=null==r?void 0:r.extra)||void 0===t?void 0:t.platform,this._frvrID=null==r?void 0:r.sub):(this._refreshToken=null,this._refreshPayload=null,this._refreshExpiration=0,this._platform=null,this._frvrID=null)}get refreshToken(){return this._refreshToken}get accessExpiration(){return this._accessExpiration}get refreshExpiration(){return this._refreshExpiration}get platform(){return this._platform}get frvrID(){return this._frvrID}get isVerified(){return this._verified}get accessIssuedAt(){return this._accessIAT}get timeTillAccessExpiry(){return this.accessToken?Math.floor(this._accessExpiration-Date.now()/1e3):-1}get accessLifespan(){return this.accessToken?this._accessExpiration-this._accessIAT:0}updateTokens(e,t){this.accessToken=e,this.refreshToken=t}updateTokensIfValid(e,t){const r=this.accessToken,i=this.refreshToken;this.updateTokens(e,t),this.isAccessValid()&&this.isRefreshValid()||(this.accessToken=r,this.refreshToken=i)}isAccessValid(){return!!this._accessToken&&1e3*(this._accessExpiration-60)>Date.now()}isRefreshValid(){return!!this._refreshToken&&1e3*(this._refreshExpiration-60)>Date.now()}isAnyValid(){return this.isRefreshValid()||this.isAccessValid()}shouldRefresh(){return this.isRefreshValid()&&!this.isAccessValid()}getAccessPayload(){return this._accessPayload}getRefreshPayload(){return this._refreshPayload}}const Ze="__FRVR_auth_refresh_token",et="__FRVR_auth_access_token";class tt{constructor(){this._currentPair=new Xe,this.pairsPerPlatform={},this.storage=c}initFromStorage(e=c){return r(this,void 0,void 0,(function*(){this.storage=e;const t=yield this.storage.getItem(Ze),r=yield this.storage.getItem(et);this.currentPair=new Xe(r,t)}))}getAccessToken(){return this.currentPair.accessToken}getRefreshToken(){return this.currentPair.refreshToken}getFRVRID(){return this.currentPair.frvrID}isVerified(){return this.currentPair.isVerified}shouldRefresh(){return this.currentPair.shouldRefresh()}getCurrentPlatform(){return this.currentPair.platform}getAvailablePlatforms(){var e;const t=[];for(const r in this.pairsPerPlatform){const i=r;(null===(e=this.pairsPerPlatform[i])||void 0===e?void 0:e.isAnyValid())&&t.push(i)}return t}get availableTokens(){return this.pairsPerPlatform}setAsCurrent(e){this.currentPair=e,this.storage.setItem(Ze,e.refreshToken),this.storage.setItem(et,e.accessToken)}addPairAsCurrent(e,t){const r=new Xe(e,t);this.setAsCurrent(r)}updateCurrentPair(e,t){this.setAsCurrent(new Xe(e,t))}updateAndValidateCurrentPair(e,t){return this.updateCurrentPair(e,t),this.isAccessValid()}deleteTokens(){this.currentPair=new Xe,this.pairsPerPlatform={},this.storage.removeItems([Ze,et])}isAccessValid(){return this.currentPair.isAccessValid()}isRefreshValid(){return this.currentPair.isRefreshValid()}isAnyValid(){return this.currentPair.isAnyValid()}get currentPair(){return this._currentPair}set currentPair(e){this._currentPair=e,(null==e?void 0:e.platform)&&(this.pairsPerPlatform[e.platform]=e)}}var rt;!function(e){e.FRVR="frvr",e.ANONYMOUS="anonymous",e.FACEBOOK_INSTANT="facebook-instant",e.FACEBOOK_SDK="facebook-web",e.GOOGLE_INTERNAL="google-internal",e.SAMSUNG_INSTANT="samsung-instant",e.APPLE="apple",e.DISCORD="discord",e.MICROSOFT="microsoft"}(rt||(rt={}));const it={AUTH_REGISTRATION:{method:"POST",path:"/register"},AUTH_LOGIN:{method:"POST",path:"/login"},AUTH_REFRESH:{method:"POST",path:"/refresh"},AUTH_RECOVER:{method:"POST",path:"/recover"},AUTH_RECOVER_CHALLENGE:{method:"POST",path:"/recover-challenge"},AUTH_VERIFY:{method:"POST",path:"/verify"},AUTH_VERIFY_CHALLENGE:{method:"POST",path:"/verify-challenge"},AUTH_SETTINGS:{method:"POST",path:"/settings"},USER_VERIFIED:{method:"GET",path:"/user/verified"}};class st{constructor(t={}){var r;this.ongoingFRVRLogin=null,this.apiBaseURL=(null===(r=t.config)||void 0===r?void 0:r.overrideBackendURL)||(t.env==e.Env.PRODUCTION?"https://crucible.frvr.com/v1/auth":"https://staging.crucible.frvr.com/v1/auth")}isLoggingIn(){return!!this.ongoingFRVRLogin}register(e){return r(this,void 0,void 0,(function*(){const t={platform:rt.FRVR,credentials:e},r={201:()=>ze.REG_SUCCESS,409:()=>{throw ze.REG_CONFLICT}};return this.fetchAndHandleCommonErrors(it.AUTH_REGISTRATION,r,t)}))}login(e){return r(this,void 0,void 0,(function*(){if(this.ongoingFRVRLogin)return this.ongoingFRVRLogin;const t={201:e=>r(this,void 0,void 0,(function*(){const t=yield e.json(),r=new Xe(t.accessToken,t.refreshToken);if(r.isAccessValid())return Object.assign(Object.assign({},ze.LOGIN_SUCCESS),{tokenPair:r});throw ze.SERVER_ERROR})),401:()=>{throw ze.INVALID_CREDENTIALS},403:()=>{throw ze.ACCOUNT_NOT_ACTIVE}};return this.ongoingFRVRLogin=this.fetchAndHandleCommonErrors(it.AUTH_LOGIN,t,e),this.ongoingFRVRLogin.finally((()=>{this.ongoingFRVRLogin=null}))}))}loginAsAnonymous(){return r(this,void 0,void 0,(function*(){return this.login({platform:rt.ANONYMOUS})}))}checkVerification(e){return r(this,void 0,void 0,(function*(){const t={200:e=>r(this,void 0,void 0,(function*(){const t=yield e.json();return null==t?void 0:t.verified}))};return this.fetchAndHandleCommonErrors(it.USER_VERIFIED,t,void 0,{"X-REFRESH-TOKEN":e.refreshToken})}))}initiateVerifyChallenge(e){return r(this,void 0,void 0,(function*(){const t={platform:rt.FRVR,credentials:e},r={201:()=>ze.OPERATION_SUCCESS,401:()=>{throw ze.INVALID_CREDENTIALS}};return this.fetchAndHandleCommonErrors(it.AUTH_VERIFY_CHALLENGE,r,t)}))}initiateRecoveryChallenge(e){return r(this,void 0,void 0,(function*(){const t={platform:rt.FRVR,credentials:e},r={201:()=>ze.OPERATION_SUCCESS,401:()=>{throw ze.INVALID_CREDENTIALS}};return this.fetchAndHandleCommonErrors(it.AUTH_RECOVER_CHALLENGE,r,t)}))}changePassword(e,t){return r(this,void 0,void 0,(function*(){const r={platform:rt.FRVR,credentials:{newPassword:t}},i={200:()=>ze.OPERATION_SUCCESS,401:()=>{throw ze.INVALID_CREDENTIALS}};return this.fetchAndHandleCommonErrors(it.AUTH_SETTINGS,i,r,{Authorization:`Bearer ${e}`})}))}refreshTokens(e){return r(this,void 0,void 0,(function*(){return this.fetchAndHandleCommonErrors(it.AUTH_REFRESH,{201:t=>r(this,void 0,void 0,(function*(){const r=yield t.json();if(!r.accessToken||!r.refreshToken)throw ze.SERVER_ERROR;if(e.updateTokensIfValid(r.accessToken,r.refreshToken),e.isAccessValid())return ze.OPERATION_SUCCESS;throw ze.SERVER_ERROR})),401:()=>{throw ze.INVALID_CREDENTIALS}},{refreshToken:e.refreshToken})}))}fetchAndHandleCommonErrors(e,t,i={},s={}){return r(this,void 0,void 0,(function*(){const{path:r,method:o}=e,n=this.apiBaseURL+r,a={method:o,headers:Object.assign({"Content-Type":"application/json"},s),body:i&&JSON.stringify(i)};let d;try{d=yield fetch(n,a)}catch(e){throw Object.assign(Object.assign({},ze.NETWORK_ERROR),{payload:{error:e}})}if(!d)throw ze.NETWORK_ERROR;if(t[d.status])return t[d.status](d);switch(d.status){case 400:throw ze.INVALID_FORMAT;case 500:throw ze.SERVER_ERROR;default:throw Object.assign(Object.assign({},ze.UNKNOWN_ERROR),{payload:{status:d.status,url:e}})}}))}}class ot{constructor(e={}){var t,r,i,o,n,a,d;this.loginStatusListeners=[],this.proactiveRefreshTimeoutID=-1,this.logger=null!==(t=e.logger)&&void 0!==t?t:s,this.providers=null!==(r=e.providers)&&void 0!==r?r:[],this.storage=null!==(i=e.storage)&&void 0!==i?i:c,this.serviceClient=null!==(o=e.serviceClient)&&void 0!==o?o:new st(e),this.tokenHandler=null!==(n=e.tokenHandler)&&void 0!==n?n:new tt,this._isFRVRLoginEnabled=!this.providers.find((e=>e.prohibitsLoginWithFRVRCredentials())),this._isAnonymousLoginEnabled=this._isFRVRLoginEnabled&&null!==(d=null===(a=e.config)||void 0===a?void 0:a.enableAnonymousLogin)&&void 0!==d&&d}init(){var e;return r(this,void 0,void 0,(function*(){yield this.tokenHandler.initFromStorage(this.storage);const t={loginWithProvider:this.loginWithProvider.bind(this)};let r=!1;for(const i of this.providers)if(yield i.init(t),i.getCredentials()&&!r){if(r=!0,null===(e=i.handlesFRVRLogin)||void 0===e?void 0:e.call(i))break;this.loginWithProvider(i).catch((e=>{var t;null===(t=this.logger)||void 0===t||t.warn(`Auto login with platform ${i.getPlatformId} failed!`,e)}))}r||!this.isLoggedIn()?!r&&this._isAnonymousLoginEnabled&&this.loginAsAnonymous().catch((e=>{var t;null===(t=this.logger)||void 0===t||t.warn("Auto login with anonymous account failed!",e)})):this.onLoginStatusChange()}))}getAccessToken(){return this.shouldRefreshTokens()?null:this.tokenHandler.getAccessToken()}getFRVRID(){return this.isLoggedIn()?this.tokenHandler.getFRVRID():null}isVerified(){return this.tokenHandler.isVerified()}getCredentials(){if(!this.isLoggedIn())return;return Object.assign({[rt.FRVR]:{userID:this.tokenHandler.getFRVRID(),accessToken:this.tokenHandler.getAccessToken(),isTokenExpired:!this.tokenHandler.isAccessValid(),isVerified:this.tokenHandler.isVerified()}},this.getThirdPartyCredentials())}getThirdPartyCredentials(){const e={};return this.providers.forEach((t=>{t&&t.isLoggedIn()&&(e[t.getPlatformId()]=t.getCredentials())})),e}isLoggedIn(){return this.tokenHandler.isAnyValid()}isLoggingIn(){return this.serviceClient.isLoggingIn()||!!this.providers.find((e=>e.isLoggingIn()))}getCurrentPlatform(){return this.tokenHandler.getCurrentPlatform()}getAvailableLoginPlatforms(){return this.providers.filter((e=>e.isLoginSupported())).map((e=>e.getPlatformId()))}isPlatformAvailable(e){return!!this.providers.find((t=>t.isLoginSupported()&&t.getPlatformId()==e))}isFRVRLoginEnabled(){return this._isFRVRLoginEnabled}isLogoutSupported(){return!this.providers.find((e=>!e.isLogoutSupported()))}addStatusChangeListener(e){this.loginStatusListeners.push(e)}registerOnFRVR(e,t=!0){return r(this,void 0,void 0,(function*(){return this.serviceClient.register(e).then((()=>this.loginToFRVR({platform:rt.FRVR,credentials:e}))).catch((r=>{if(r.type==ze.REG_CONFLICT.type&&t)return this.loginToFRVR({platform:rt.FRVR,credentials:e});throw r}))}))}loginToFRVR(e){return r(this,void 0,void 0,(function*(){return this.serviceClient.login(e).then((e=>r(this,void 0,void 0,(function*(){if(e.tokenPair){this.tokenHandler.setAsCurrent(e.tokenPair);for(const e of this.providers)e.onFRVRTokensReceived&&(yield e.onFRVRTokensReceived(this.tokenHandler.currentPair));this.onLoginStatusChange()}return t(e,["tokenPair"])}))))}))}loginAsAnonymous(){return r(this,void 0,void 0,(function*(){if(!this._isAnonymousLoginEnabled)throw ze.PLATFORM_NOT_AVAILABLE;const e=yield this.serviceClient.loginAsAnonymous(),{tokenPair:r}=e,i=t(e,["tokenPair"]);if(r){this.tokenHandler.setAsCurrent(r);for(const e of this.providers)e.onFRVRTokensReceived&&(yield e.onFRVRTokensReceived(this.tokenHandler.currentPair));this.onLoginStatusChange()}return i}))}loginThroughPlatform(e){return r(this,void 0,void 0,(function*(){let t;if(t=e||1!=this.providers.length?this.providers.find((t=>t.getPlatformId()==e)):this.providers[0],!t)throw ze.PLATFORM_NOT_AVAILABLE;return t.login().catch((e=>{throw Object.assign(Object.assign({},ze.PLATFORM_LOGIN_FAIL),{payload:{platform:t.getPlatformId(),error:e}})})).then((e=>{if(e)return this.loginWithProvider(t);throw Object.assign(Object.assign({},ze.PLATFORM_LOGIN_FAIL),{payload:{platform:t.getPlatformId()}})}))}))}login(e,t){return e&&t?this.loginToFRVR({platform:e,credentials:t}):this.loginThroughPlatform(e)}logout(){this.tokenHandler.deleteTokens(),this.providers.forEach((e=>{e.logout()})),this.onLoginStatusChange()}mergeAccounts(e,t){return r(this,void 0,void 0,(function*(){}))}initiateVerifyChallenge(e){return r(this,void 0,void 0,(function*(){return this.serviceClient.initiateVerifyChallenge(e)}))}initiateRecoveryChallenge(e){return r(this,void 0,void 0,(function*(){return this.serviceClient.initiateRecoveryChallenge(e)}))}changePassword(e){return r(this,void 0,void 0,(function*(){if(!this.isLoggedIn())throw ze.NOT_LOGGED_IN;return this.serviceClient.changePassword(this.tokenHandler.getRefreshToken(),e)}))}synchronizeVerifiedStatus(){return r(this,void 0,void 0,(function*(){return!(!this.isVerified()&&this.isLoggedIn())||this.serviceClient.checkVerification(this.tokenHandler.currentPair).then((e=>!!e&&this.refreshCurrentPair().then((()=>!0))))}))}authenticatedFetch(e,t){return r(this,void 0,void 0,(function*(){return t=yield this.decorateRequestWithAuth(t),fetch(e,t)}))}decorateRequestWithAuth(e){return r(this,void 0,void 0,(function*(){if(this.shouldRefreshTokens()&&(yield this.refreshCurrentPair()),!this.tokenHandler.isAccessValid())throw ze.NOT_LOGGED_IN;return Object.assign(Object.assign({},e),{headers:Object.assign(Object.assign({"Content-Type":"application/json"},e.headers),{Authorization:`Bearer ${this.tokenHandler.getAccessToken()}`})})}))}onLoginStatusChange(){const e=this.isLoggedIn();this.loginStatusListeners.forEach((t=>{t(e)})),this.updateProactiveRefresh()}getFreshAccessToken(){return r(this,void 0,void 0,(function*(){return this.shouldRefreshTokens()&&(yield this.refreshCurrentPair()),this.tokenHandler.getAccessToken()}))}shouldRefreshTokens(){return this.tokenHandler.shouldRefresh()}refreshTokens(e){return r(this,void 0,void 0,(function*(){const t=this.serviceClient.refreshTokens(e);return t.then((()=>{this.updateProactiveRefresh()})).catch((()=>{})),t.catch((t=>r(this,void 0,void 0,(function*(){const r=this.providers.find((t=>t.getPlatformId()==e.platform));if(t.type!=Ye.invalidCredentials||!(null==r?void 0:r.isLoggedIn()))throw this.tokenHandler.isAccessValid()?this.updateProactiveRefresh():this.logout(),t;try{return yield this.loginWithProvider(r),!0}catch(e){throw this.logout(),e}}))))}))}refreshCurrentPair(){return r(this,void 0,void 0,(function*(){return this.refreshTokens(this.tokenHandler.currentPair).then((e=>r(this,void 0,void 0,(function*(){for(const e of this.providers)e.onFRVRTokensReceived&&(yield e.onFRVRTokensReceived(this.tokenHandler.currentPair));return e}))))}))}loginWithProvider(e){return r(this,void 0,void 0,(function*(){return this.loginToFRVR({platform:null==e?void 0:e.getPlatformId(),credentials:null==e?void 0:e.getCredentials()})}))}updateProactiveRefresh(){window.clearTimeout(this.proactiveRefreshTimeoutID),this.isLoggedIn()&&(this.proactiveRefreshTimeoutID=window.setTimeout((()=>{this.refreshCurrentPair()}),1e3*this.getTimeTillProactiveRefresh()))}getTimeTillProactiveRefresh(){var e;if(!this.tokenHandler.isRefreshValid())return Number.MAX_SAFE_INTEGER;const t=this.tokenHandler.currentPair,r=.4*((null!==(e=t.accessIssuedAt)&&void 0!==e?e:Date.now()/1e3)+t.accessLifespan-Math.floor(Date.now()/1e3));return Math.max(30,r)}get responseTypes(){return Ye}get platforms(){return rt}}var nt=Object.freeze({__proto__:null});class at extends Error{constructor(e,t){super(e),this.code=t,this.name="FeaturesClientNetworkError",this.code=t}}function dt(e,t){return new Promise(((r,i)=>{const s=setTimeout((()=>i(new Error(`Timeout after ${t}ms`))),t);e.then((e=>{clearTimeout(s),r(e)})).catch((e=>{clearTimeout(s),i(e)}))}))}class ct{constructor({accessProvider:e,gameId:t,debugProvider:r,apiUrl:i,channelId:s}){this.accessProvider=e,this.gameId=t,this.debugProvider=r,this.baseUrl=null!=i?i:"https://crucible.frvr.com",this.channelId=s}getFeatures(){return r(this,void 0,void 0,(function*(){const e=new URLSearchParams;if(this.debugProvider){const t=yield this.debugProvider.getProperty("_overrideRemoteConfig");t&&e.append("debug",t)}this.channelId&&e.append("channel",this.channelId);const t={"Content-Type":"application/json"},r=yield this.accessProvider.getAccessToken();r?t.Authorization=`Bearer ${r}`:e.append("userId",yield this.accessProvider.getUserId());let i=e.toString();i&&(i=`?${i}`);const s=r?`${this.baseUrl}/v1/tailor/${this.gameId}/config${i}`:`${this.baseUrl}/v1/tailor/guest/${this.gameId}/config${i}`,o=yield fetch(s,{headers:t});if(!o.ok)throw new at(`Failed to fetch features: ${o.status} ${o.statusText}`,o.status);return yield o.json()}))}}function ht(e){return function(e,t,i,s){return()=>r(this,void 0,void 0,(function*(){let r=yield e.getItem(t);const o=null==r?void 0:r.createdAt;s&&o&&Date.now()-o>=24*s*60*60*1e3&&(r=void 0);const n=null==r?void 0:r.value;if(n)return String(n);const a=yield i();return yield e.setItem(t,{value:a,createdAt:Date.now()}),a}))}(e,"__frvr_rfc_uuidv4",(()=>r(this,void 0,void 0,(function*(){return"undefined"!=typeof window&&window.crypto&&window.crypto.randomUUID?window.crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}))}))),365)}const lt="__frvr_features";class ut{constructor({client:e,auth:t,debugProvider:i,localStorage:s,logger:o,config:n,remoteABTests:a,channelId:d}){var c;this.firstFetch=!0,this.auth=t,this.anonymousIdProvider=ht(s);const h={getAccessToken:()=>r(this,void 0,void 0,(function*(){return this.auth.getAccessToken()})),getUserId:()=>r(this,void 0,void 0,(function*(){return this.anonymousUserId}))};this.client=null!=e?e:new ct({accessProvider:h,debugProvider:i,gameId:n.gameId,apiUrl:n.apiUrl,channelId:d}),this.localStorage=s,this.logger=o,this.config=n,this.remoteABTests=a,this.defaultFeatures=null!==(c=n.defaultFeatures)&&void 0!==c?c:{}}init(){return r(this,void 0,void 0,(function*(){this.preStoredConfig=yield this.localStorage.getItem(lt),this.anonymousUserId=yield this.anonymousIdProvider()}))}getFeature(e,t=!1){return r(this,void 0,void 0,(function*(){return this.getFeatures([e],t).then((t=>t[e]))}))}getFeatures(e,t=!1){var i,s,o;return r(this,void 0,void 0,(function*(){yield this.fetchFeatures(t);const r=null!==(i=this.remoteConfig)&&void 0!==i?i:this.preStoredConfig,n=null!==(s=null==r?void 0:r.config)&&void 0!==s?s:this.defaultFeatures;return this.remoteConfig&&this.setupGroups(null!==(o=null==r?void 0:r.groups)&&void 0!==o?o:[]),e&&0!==e.length?e.reduce(((e,t)=>(e[t]=n[t],e)),{}):n}))}getGroups(){return this.groups}setupGroups(e){var t;this.groups||(this.groups=e,e.length>0&&(null===(t=this.remoteABTests)||void 0===t||t.setGroups(e)))}fetchFeatures(e){return r(this,void 0,void 0,(function*(){if(this.firstFetchPromise)return this.firstFetchPromise;if(!this.firstFetch&&!e)return;this.groups=void 0,this.firstFetch=!1;const t=this.getUserId();t&&this.preStoredConfig&&t!==this.preStoredConfig.userId&&(yield this.removePreStoredConfig());return this.firstFetchPromise=(()=>r(this,void 0,void 0,(function*(){var e;let t;try{const r=null!==(e=this.config.timeout)&&void 0!==e?e:1e3;yield dt(this.auth.getFreshAccessToken(),r),t=yield dt(this.client.getFeatures(),r)}catch(e){this.logger.error(["Failed to fetch features:",e.code,e.message].filter((e=>e)).join(" "));e instanceof at&&404===e.code&&(yield this.removePreStoredConfig())}return t&&(yield this.savePreStoredConfig(t)),t})))().then((e=>{this.remoteConfig=e,this.firstFetchPromise=void 0})).catch((e=>{this.logger.error(`Failed to fetch features: ${e.message}`),this.firstFetchPromise=void 0})),this.firstFetchPromise}))}savePreStoredConfig(e){const t=Object.assign(Object.assign({},e),{userId:this.getUserId()});return this.localStorage.setItem(lt,t)}removePreStoredConfig(){return this.preStoredConfig=void 0,this.localStorage.removeItem(lt)}getUserId(){return this.auth.getFRVRID()}}class gt{constructor(e){this.tracker=e}setGroups(e){var t;const r=this.getTrackerPlaySessionId();if(r===this.playSessionId)return;if(null===(t=this.contextRemoveFn)||void 0===t||t.call(this),0===e.length)return;this.playSessionId=r;const i=function(e){const t={};for(const r of e){const e=0===r.groupId?"control":r.groupId<=26?String.fromCharCode(96+r.groupId):`${r.groupId}`;t[r.testName]=`${r.testName}__${e}`}return t}(e),s=function(e,t){const r={};for(const i in t)r[`${e}_${i}`]=t[i];return r}("abt",i);for(const e in i){const t=i[e];this.tracker.logValuedEvent("ab_test_activation",1,{ab_test_name:e,ab_test_group:t})}this.contextRemoveFn=this.tracker.addExtraFieldFunction((e=>{Object.assign(e,s)}))}getTrackerPlaySessionId(){return this.tracker.getPlaySessionId()}}class vt{constructor(e,t){this.primaryDebugProvider=e,this.fallbackStorageProvider=t}getProperty(e){var t;return r(this,void 0,void 0,(function*(){const r=yield null===(t=this.primaryDebugProvider)||void 0===t?void 0:t.getProperty(e);return void 0===r?this.fallbackStorageProvider.getItem(e):r}))}}function pt(e){window.addEventListener("focus",(()=>{e.onShow()})),window.addEventListener("blur",(()=>{e.onHide()}))}function mt(e){window.addEventListener("focus",(()=>{e.onResume()})),window.addEventListener("blur",(()=>{e.onSuspend()}))}const ft={providers:[{name:"dev",type:"interstitial",priority:1},{name:"dev",type:"reward",priority:2}],throttling:{maxfrequency:5e3}},yt={onGamePause:()=>{},onSuspend:()=>{},onResume:()=>{},onAudioSuspend:()=>{},onAudioResume:()=>{},onShow:()=>{},onHide:()=>{}};class It{constructor(e,t,r,i,s){this.bootstrapper=e,this.postInit=t,this.preComplete=r,this.postComplete=i,this.consentProvider=s}init(){return this.consentProvider.consentToTerms(),this.bootstrapper.init().then((()=>this.postInit()))}setProgress(e){this.bootstrapper.setProgress(e)}complete(){return this.preComplete().then((()=>this.bootstrapper.complete())).then((()=>this.postComplete()))}}class Pt{init(){return r(this,void 0,void 0,(function*(){}))}getId(){return"empty"}onModulesUpdated(e){}setConfig(e){}getLogger(){return console}getBootstrapper(){return l}getConsentProvider(){return f}getAnalyticsProviders(){return[]}getAnalyticsIDProvider(){return ie}getABTestsUniqueId(){return""}getAdsProviders(e){return[]}getIAPProvider(){return Ie}getLocalStorageProvider(){return h([d.providerName])}getCloudStorageProvider(){return r(this,void 0,void 0,(function*(){return h([d.providerName])}))}getShortcutProvider(){return g}getTrackerContextProvider(){return()=>({})}getNotificationsProvider(){return Ne}getCrossplay(){return p}getCrosspromo(){return _}getSocialProvider(){return $}getLiveRoomProvider(){return Q}getTournamentsProvider(){return Ge}getChallengesProvider(){return We}getLeaderboardsProvider(){return qe}getProfile(){return I}getAuthProviders(e,t){return[]}getCharacteristics(){return P}getEntryPointProvider(){return S}getCommunityProvider(){return E}getAdsConfig(e){return r(this,void 0,void 0,(function*(){return e}))}getNavigationProvider(){return b}}function St(e){const t=Object.getOwnPropertyNames(Pt.prototype),r={};for(const i of t)"constructor"!==i&&e[i]&&(r[i]=e[i].bind(e));return r}class Et{constructor(e){this.shortcutProvider=e}init(){return this.shortcutProvider.init()}canCreateShortcut(){return this.shortcutProvider.canCreateShortcut()}createShortcut(){return this.shortcutProvider.createShortcut()}canCreateShortcutAsync(){return this.canCreateShortcut()}createShortcutAsync(){return this.createShortcut()}}class bt extends Error{constructor(e,t){super(e),this.code=t,this.name="ShopError",this.code=t,Object.setPrototypeOf(this,bt.prototype)}}class _t{constructor({accessProvider:e,gameId:t,apiUrl:r}){this.accessProvider=e,this.gameId=t,this.baseUrl=null!=r?r:"https://crucible.frvr.com"}getShop(e="",t){var i;return r(this,void 0,void 0,(function*(){const r=new URLSearchParams;e&&r.set("shopfrontId",e);const s={"Content-Type":"application/json"},o=this.accessProvider.getAccessToken();if(!o)throw new bt("Shop access token is required",0);s.Authorization=`Bearer ${o}`;let n=r.toString();n&&(n=`?${n}`);const a=`${this.baseUrl}/v1/shop/${this.gameId}${n}`,d=yield fetch(a,{headers:s});if(!d.ok)throw new At(`Failed to fetch shop data: ${d.status} ${d.statusText}`,d.status);const c=yield d.json();return null!==(i=null==t?void 0:t(c))&&void 0!==i?i:c}))}getProducts(e,t){var i;return r(this,void 0,void 0,(function*(){const r={"Content-Type":"application/json"},s=this.accessProvider.getAccessToken();if(!s)throw new bt("Shop access token is required",0);r.Authorization=`Bearer ${s}`;let o="";e&&(o=`?productSKUs=${e.toString()}`);const n=`${this.baseUrl}/v1/shop/${this.gameId}/products/${o}`,a=yield fetch(n,{headers:r});if(!a.ok)throw new At(`Failed to fetch shop data: ${a.status} ${a.statusText}`,a.status);const d=(yield a.json()).items;return null!==(i=null==t?void 0:t(d))&&void 0!==i?i:d}))}}class At extends bt{constructor(e,t){super(e,t),this.code=t,Object.setPrototypeOf(this,At.prototype)}}class Tt{constructor(e){this.client="client"in e?e.client:new _t(e),this.logger=e.logger,this.iap=e.iap}getShop(e=""){return r(this,void 0,void 0,(function*(){let t;try{t=yield this.client.getShop(e,Ot)}catch(e){if(404===e.code)return Ct;throw e}return t=this.withChannel(this.withFormattedPrices(t)),t}))}getProducts(e){return r(this,void 0,void 0,(function*(){if(0===e.length)return[];let t;try{t=yield this.client.getProducts(e,Ot)}catch(e){if(404===e.code)return[];throw e}return t}))}withFormattedPrices(e){return Object.assign(Object.assign({},e),{modules:e.modules.map((e=>Object.assign(Object.assign({},e),{products:e.products.map((e=>e.price.currency===Rt?Object.assign(Object.assign({},e),{price:Object.assign(Object.assign({},e.price),{formattedAmount:this.getFormattedPrice(e)})}):e))})))})}withChannel(e){const t=this.iap.getProviderName(),r=wt[t];return Object.assign(Object.assign({},e),{channelSku:r})}getFormattedPrice(e){var t,r;const i=this.iap.getProviderName(),s=wt[i],o=null===(r=null===(t=e.channels)||void 0===t?void 0:t[s])||void 0===r?void 0:r.sku,n=this.iap.getProductById(o);if(n)return n.price;this.logger.warn(`[shop] No IAP product found for sku ${e.sku}/${o} in provider ${i}`)}}const Rt="iap",Ct={_id:"",gameId:"",currencies:[],modules:[],metadata:{},defaultShopfrontId:""},wt={"fbi-iap-provider":"facebook_instant",discord:"discord","google-play-iap-provider":"facebook_instant","ios-iap-provider":"facebook_instant","samsung-galaxy-iap-provider":"facebook_instant",samsung_instant_play:"facebook_instant"};function Ot(e){return kt(e,["availableAt","archivedAt","createdAt","updatedAt"],(e=>e&&new Date(e)))}function kt(e,t,r){if("object"!=typeof e||null===e)return e;if(Array.isArray(e))return e.map((e=>kt(e,t,r)));const i={};for(const[s,o]of Object.entries(e))i[s]=t.includes(s)?r(o):kt(o,t,r);return i}class Lt{constructor(){this.lifecycle=Object.assign({},yt),this.config={}}setChannel(e){if(this.channel){if(this.initPromise)return void this.logger.error("[FRVR-SDK] channel cannot be set after init");this.logger.warn("[FRVR-SDK] setting channel multiple times")}this.channel=e}init(t=e.Env.DEVELOPMENT){var r;return this.channel=function(...e){const t={},r=e.filter((e=>e)).map(St);return Object.assign(t,...r),t}(new Pt,this.channel),null===(r=this.logger)||void 0===r||r.log("[FRVR-SDK - init] config:",this.config),this.channel.setConfig(this.config),this.buildComponents(t),this.initPromise=this.channel.init().then((()=>this.initTracker())).then((()=>this.initComponents(t))),this.initPromise}buildComponents(t){var r,i,n,a,d,c,h,l,u,g,v,p,m,f,y,I,P,S;this.logger||(this.logger=t===e.Env.PRODUCTION&&s||this.channel.getLogger()),this.channel.onModulesUpdated(this),this.logger.debug("[FRVR-SDK] building components"),this.entrypoint=this.channel.getEntryPointProvider(),this.localStorage||(this.localStorage=new o({provider:this.channel.getLocalStorageProvider(this.config.storage),logger:this.logger})),this.channel.onModulesUpdated(this),this.consentProvider=this.channel.getConsentProvider(),this.tracker||(this.tracker=new he({storage:this.localStorage,logger:this.logger,analyticsProviders:this.channel.getAnalyticsProviders((null===(r=this.config.tracker)||void 0===r?void 0:r.analyticsProviders)||{},t),idProvider:this.channel.getAnalyticsIDProvider(this.localStorage),contextProvider:this.channel.getTrackerContextProvider((null===(i=this.config.tracker)||void 0===i?void 0:i.trackerChannelId)||(null===(n=this.channel)||void 0===n?void 0:n.getId())),consentProvider:this.consentProvider,appContextFields:{context:(null===(a=this.config.tracker)||void 0===a?void 0:a.gameId)||this.config.gameId,app_version:null===(d=this.config.tracker)||void 0===d?void 0:d.appVersion,app_build:null===(c=this.config.tracker)||void 0===c?void 0:c.appBuild}})),this.channel.onModulesUpdated(this),this.ads||(this.ads=new j({env:t,logger:this.logger,storage:this.localStorage,tracker:this.tracker,controls:this.lifecycle,onBeforeInit:()=>this.registerAdsProviders()})),this.notifications||(this.notifications=new ke({logger:this.logger,provider:this.channel.getNotificationsProvider(),tracker:this.tracker})),this.bootstrapper||(this.bootstrapper=new It(this.channel.getBootstrapper(),(()=>this.postInit(t)),(()=>this.preComplete()),(()=>this.postComplete()),this.consentProvider)),this.shortcut||(this.shortcut=new Et(this.channel.getShortcutProvider())),this.crossplay||(this.crossplay=this.channel.getCrossplay(this.tracker)),this.crosspromo||(this.crosspromo=this.channel.getCrosspromo()),this.auth||(this.auth=new ot({providers:this.channel.getAuthProviders(this.config.gameId,this.config.auth),storage:this.localStorage,env:t,config:this.config.auth,logger:this.logger})),this.channel.onModulesUpdated(this),this.iap||(this.iap=new Re({provider:this.channel.getIAPProvider(new Ce({env:t,auth:this.auth,channelId:null===(h=this.channel)||void 0===h?void 0:h.getId(),gameId:this.config.gameId,apiHostOverride:null===(l=this.config.iap)||void 0===l?void 0:l.hostOverride})),tracker:this.tracker,logger:this.logger}));const E=Object.assign(Object.assign({},this.config.features),{gameId:null!==(g=null===(u=this.config.features)||void 0===u?void 0:u.gameId)&&void 0!==g?g:this.config.gameId}),b=this.entrypoint.getProperty?this.entrypoint:void 0,_=new vt(b,this.localStorage);this.features||(this.features=new ut({logger:this.logger,auth:this.auth,debugProvider:_,localStorage:this.localStorage,remoteABTests:new gt(this.tracker),config:E,channelId:null===(v=this.channel)||void 0===v?void 0:v.getId()}));const A=Object.assign(Object.assign({env:t},this.config.social),{gameId:null!==(m=null===(p=this.config.social)||void 0===p?void 0:p.gameId)&&void 0!==m?m:this.config.gameId});this.social||(this.social=new z(A,{logger:this.logger,provider:this.channel.getSocialProvider(),auth:this.auth})),this.liveRoom||(this.liveRoom=new X({logger:this.logger,provider:this.channel.getLiveRoomProvider(),auth:this.auth})),this.tournaments||(this.tournaments=new Be({logger:this.logger,provider:this.channel.getTournamentsProvider(),auth:this.auth})),this.challenges=new $e({logger:this.logger,provider:this.channel.getChallengesProvider()}),this.leaderboards=new Ke({provider:this.channel.getLeaderboardsProvider()}),this.profile||(this.profile=this.channel.getProfile()),this.channelCharacteristics||(this.channelCharacteristics=this.channel.getCharacteristics()),this.community||(this.community=this.channel.getCommunityProvider());const T=Object.assign(Object.assign({},this.config.navigation),{gameId:null!==(y=null===(f=this.config.navigation)||void 0===f?void 0:f.gameId)&&void 0!==y?y:this.config.gameId});this.navigation||(this.navigation=this.channel.getNavigationProvider(T)),this.shop||(this.shop=new Tt({apiUrl:null===(I=this.config.shop)||void 0===I?void 0:I.apiUrl,accessProvider:this.auth,gameId:null!==(S=null===(P=this.config.shop)||void 0===P?void 0:P.gameId)&&void 0!==S?S:this.config.gameId,logger:this.logger,iap:this.iap}))}initTracker(){return r(this,void 0,void 0,(function*(){yield this.tracker.init(),this.tracker.logEvent("page_loading",{})}))}initComponents(e){return r(this,void 0,void 0,(function*(){this.logger.debug("[FRVR-SDK] initialising components"),this.addDefaultListeners(e),yield this.configAds(e),this.config.gameId?(this.notifications.configure({game:this.config.gameId}),this.tournaments.init(this.config.gameId,e),this.leaderboards.init(this.config.gameId,e)):this.logger.error("[FRVR-SDK] Missing game's name in configuration"),this.crossplay.needsConfiguration()&&(this.config.crossplay?this.crossplay.configure(this.config.crossplay):this.logger.error("[FRVR-SDK] Missing crossplay configuration"))}))}postInit(e){var t,i;return r(this,void 0,void 0,(function*(){this.logger.debug("[FRVR-SDK] post init"),console.warn("pre init promise"),yield this.initPromise,console.warn("post init promise");const s=null===(i=null===(t=this.config.ads)||void 0===t?void 0:t.autoInit)||void 0===i||i;console.warn("ads auto init",s),yield Promise.all([(()=>r(this,void 0,void 0,(function*(){let t;try{t=yield this.channel.getCloudStorageProvider(this.config.cloudStorage,e)}catch(e){this.logger.error("[FRVR-SDK] error initialising cloud storage",e)}this.cloudStorage=new o({provider:t||new d,logger:this.logger})})))(),s&&this.ads.init(),(()=>r(this,void 0,void 0,(function*(){yield this.iap.init(),yield this.iap.configure(this.config.iap)})))(),this.shortcut.init(),this.notifications.init(),this.auth.init(),this.features.init(),(()=>r(this,void 0,void 0,(function*(){this.config.gameId?yield this.challenges.init(this.config.gameId,this.entrypoint,e):this.logger.error("[FRVR-SDK] Missing game's name in configuration")})))()]),console.warn("done postinit")}))}preComplete(){return r(this,void 0,void 0,(function*(){this.logger.debug("[FRVR-SDK] pre complete"),this.tracker.loaded()}))}postComplete(){return r(this,void 0,void 0,(function*(){this.logger.debug("[FRVR-SDK] post complete"),this.tracker.logEvent("device_info",{})}))}addDefaultListeners(t){this.logger.debug("[FRVR-SDK] adding default listeners"),"undefined"!=typeof window&&pt(this.lifecycle),t===e.Env.DEVELOPMENT&&mt(this.lifecycle)}configAds(t){var i,s,o;return r(this,void 0,void 0,(function*(){this.logger.debug("[FRVR-SDK] running channel ads configuration");const r=null===(i=this.config.ads)||void 0===i?void 0:i.autoInit,n=yield null===(o=(s=this.channel).getAdsConfig)||void 0===o?void 0:o.call(s,this.config.ads);n&&(this.config.ads=Object.assign(Object.assign({},n),{autoInit:r})),this.config.ads&&(this.logger.debug("[FRVR-SDK] configuring ads"),this.ads.configure(this.config.ads)),t!==e.Env.DEVELOPMENT||this.config.ads||(this.logger.debug("[FRVR-SDK] configuring ads for dev"),this.ads.configure(ft))}))}registerAdsProviders(){var e;return r(this,void 0,void 0,(function*(){this.logger.debug("[FRVR-SDK] registering ads providers");const t=this.channel.getAdsProviders(null!==(e=this.config.ads)&&void 0!==e?e:{});for(const e of t)this.ads.register(e)}))}}return window.FRVR=new Lt,e.ACCESS_TOKEN_KEY=et,e.AdTracker=U,e.AdTypeProperties=T,e.Ads=j,e.AdsThrottler=k,e.AsyncStorage=o,e.Auth=ot,e.DEFAULT_ADS_CONFIG=ft,e.Deferred=class extends Promise{constructor(e){let t,r;super(((e,i)=>{t=e,r=i})),this._resolve=t,this._reject=r,null==e||e(t,r)}resolve(e){this._resolve(e)}reject(e){this._reject(e)}},e.FRVRAnalytics=class{constructor({legacyAnalytics:e,disableSendBeacon:t}={}){this.legacyAnalytics=null!=e?e:te(void 0,t)}init(e,t){return this.legacyAnalytics.init(e,t)}getName(){return this.legacyAnalytics.getName()}send(e,t,r,i){this.legacyAnalytics.send(e,t,r,i)}},e.FRVRSDK=Lt,e.IAP=Re,e.IAPError=be,e.IAPPurchaseErrorCancelledByUser=Ae,e.IAPPurchaseErrorUnknownProduct=_e,e.IAPServiceClient=Ce,e.IsReadyStateManager=class{constructor(e,t){this.states={},this._isReady=!1,this.requiredStates=e,this.handler=t;for(const e of this.requiredStates)this.states[e]=!1;this.updateIsReady()}updateIsReady(){const e=this._isReady;this._isReady=this.requiredStates.every((e=>this.states[e])),e!=this._isReady&&this.handler(this._isReady)}setState(e,t){this.states[e]=t,this.updateIsReady()}getState(e){return this.states[e]}get isReady(){return this._isReady}},e.MIN_PROACTIVE_REFRESH_INTERVAL=30,e.MemoryAsyncStorageProvider=d,e.Notifications=ke,e.PROACTIVE_REFRESH_THRESHOLD=.6,e.PublicCredentials=nt,e.PublicResponses=Je,e.REFRESH_TOKEN_KEY=Ze,e.StorageIDProvider=class extends ne{setCanUseCookies(){this.canUseCookies=!1}},e.TokenHandler=tt,e.Tracker=he,e.WebIDProvider=ne,e.WebLocalStorageProvider=a,e.addDefaultWebListeners=pt,e.addDevWebListeners=mt,e.buildStorageProvider=h,e.buildTrackerWebContextProvider=function(e){function t(){var e,t;return window.innerHeight||(null===(e=document.documentElement)||void 0===e?void 0:e.clientHeight)||(null===(t=document.body)||void 0===t?void 0:t.clientHeight)}const r=function(e){const t=t=>{const r=e.match(`^(?:.*${t}=([^&]*)|).*$`);return null==r?void 0:r[1]};return{utm_source:t("utm_source"),utm_medium:t("utm_medium"),utm_campaign:t("utm_campaign"),utm_term:t("utm_term"),utm_content:t("utm_content")}}((document.location.search||"").replace(/^\?/,""));return i=>{return Object.assign(Object.assign({},r),{play_session_id:i.getPlaySessionId(),channel:e,device_width:window.innerWidth||(null===(s=document.documentElement)||void 0===s?void 0:s.clientWidth)||(null===(o=document.body)||void 0===o?void 0:o.clientWidth),device_height:t()});var s,o}},e.buildWebAsyncStorage=e=>new o({provider:new a,logger:e}),e.consentToAllConsentProvider=y,e.defaultCharacteristics=P,e.defaultLifecycle=yt,e.emptyAdEventLogger=L,e.emptyAdLifecycle=R,e.emptyAnalyticsIDProvider=ie,e.emptyAsyncStorage=c,e.emptyBootstrapper=l,e.emptyCommunityProvider=E,e.emptyCrossplay=p,e.emptyCrosspromo=_,e.emptyEntryPoint=S,e.emptyIAPProvider=Ie,e.emptyLogger=s,e.emptyNavigationProvider=b,e.emptyNotificationsProvider=Ne,e.emptyProfile=I,e.emptyShortcutProvider=g,e.inMemoryChannelMapper=ye,e.noConsentConsentProvider=f,Object.defineProperty(e,"__esModule",{value:!0}),e}({});FRVRSDK.version=FRVRSDK.version||{},FRVRSDK.version.sdk=FRVRSDK.version.sdk||{},FRVRSDK.version.sdk.v="13.37.0",FRVRSDK.version.sdk.bts="1718368575807",FRVRSDK.version.sdk.branch="master";
